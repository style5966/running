<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <title>Sub-3 통합 프로그램 v4.0 — 간단/상세</title>
  <style>
    :root{
      --bg-primary:#0b1220; --bg-secondary:#0f172a; --bg-card:rgba(17,24,39,.6); --bg-blur:rgba(11,18,32,.7);
      --border-primary:rgba(148,163,184,.25);
      --text-primary:#e5e7eb; --text-muted:#9aa4b2; --text-link:#93c5fd;
      --color-primary:#38bdf8; --color-accent:#a78bfa; --color-success:#34d399; --color-warning:#f59e0b;
      --font-size-base:16px; --line-height-base:1.6;
      --quickbar-height:72px;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;color:var(--text-primary);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif;
      font-size:var(--font-size-base);line-height:var(--line-height-base);
      background:linear-gradient(180deg,var(--bg-primary),var(--bg-secondary));
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      padding-bottom:var(--quickbar-height);
    }
    @supports(padding:env(safe-area-inset-bottom)){
      body{padding-bottom:calc(var(--quickbar-height)+env(safe-area-inset-bottom))}
    }
    .container{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid--2{grid-template-columns:repeat(2,1fr)}.grid--3{grid-template-columns:repeat(3,1fr)}}

    .hero{position:relative;padding:16px;border:1px solid var(--border-primary);border-radius:16px;background:linear-gradient(180deg,rgba(2,6,23,.6),rgba(2,6,23,.4))}
    .hero__title{margin:0 0 8px;font-size:22px}
    .hero__subtitle{margin:0;color:var(--text-muted);font-size:14px}
    .hero__actions{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;min-height:44px;border-radius:10px;border:1px solid var(--border-primary);background:rgba(15,23,42,.6);color:var(--text-primary);cursor:pointer}
    .btn:hover{background:rgba(167,139,250,.12)}
    .btn[aria-pressed="true"]{outline:2px solid var(--color-accent);outline-offset:2px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border-primary);background:rgba(15,23,42,.6);min-height:40px;cursor:pointer;color:var(--text-primary)}
    .chip:hover{background:rgba(167,139,250,.12)}
    .chip[aria-pressed="true"]{outline:2px solid var(--color-primary);outline-offset:2px;color:#fff;background:rgba(56,189,248,.18)}

    .card{background:var(--bg-card);border:1px solid var(--border-primary);border-radius:16px;padding:14px}
    .title{margin:0 0 10px;font-size:16px;color:#dbeafe}
    .muted{color:var(--text-muted);font-size:13px}

    .kpi{display:grid;gap:8px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:900px){.kpi{grid-template-columns:repeat(6,1fr)}}
    .kpi__item{border:1px solid var(--border-primary);border-radius:12px;padding:10px;background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.2))}
    .kpi__val{font-weight:700}
    .kpi__lab{font-size:12px;color:var(--text-muted)}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;flex:1 1 140px}
    .field input,.field select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-primary);background:rgba(15,23,42,.6);color:var(--text-primary);min-height:44px}
    input[aria-invalid="true"]{outline:2px solid #ef4444;outline-offset:2px}

    .list{margin:0;padding-left:18px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:rgba(167,139,250,.18);border:1px solid var(--border-primary);font-size:12px}

    .helper{position:fixed;left:0;right:0;bottom:0;background:rgba(11,18,32,.88);backdrop-filter:blur(8px);border-top:1px solid var(--border-primary);z-index:10}
    .helper__in{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .helper__in .pair{display:flex;gap:6px;align-items:center;font-size:13px}
    .helper[aria-hidden="true"]{display:none}
    @supports(padding:env(safe-area-inset-bottom)){.helper__in{padding-bottom:calc(8px + env(safe-area-inset-bottom))}}
    .fab{position:fixed;right:16px;bottom:16px;z-index:11;width:48px;height:48px;border-radius:999px;border:1px solid var(--border-primary);background:rgba(15,23,42,.9);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .fab[hidden]{display:none}

    .tabs{display:flex;gap:8px;overflow:auto;margin:10px 0}
    .tbtn{padding:10px 12px;border:1px solid var(--border-primary);border-radius:999px;background:transparent;color:#c7d2fe;white-space:nowrap}
    .tbtn:hover{background:rgba(167,139,250,.12)}
    .tbtn[aria-pressed="true"]{background:rgba(167,139,250,.14);color:#fff;outline:2px solid var(--color-accent);outline-offset:1px}

    .simple .adv-only{display:none !important}

    .help-panel{display:none}
    .help-panel.is-open{display:block;border-color:rgba(167,139,250,.5)}
  </style>
</head>
<body class="simple">
  <div class="container">
    <header class="hero">
      <h1 class="hero__title">Sub-3 통합 프로그램 v4</h1>
      <p class="hero__subtitle">필수만 보이는 간단 모드. 입력 → 결과를 한 화면에서.</p>
      <div class="hero__actions">
        <button id="mode-simple" class="btn" aria-pressed="true">간단 보기</button>
        <button id="mode-advanced" class="btn" aria-pressed="false">상세 보기</button>
        <button id="help-toggle" class="btn" aria-pressed="false" aria-controls="help-panel" aria-expanded="false">도움말</button>
      </div>
    </header>

    <section id="help-panel" class="card help-panel" aria-hidden="true">
      <h3 class="title">도움말(요약)</h3>
      <ul class="muted">
        <li>거리: km·m, 시간: 분·초, 페이스: 분:초/ km 또는 분:초/ mile</li>
        <li>기록은 10K 또는 하프 하나만 입력해도 됩니다.</li>
        <li>날씨·단위 칩은 누르면 즉시 반영됩니다.</li>
        <li>상세 보기: 모든 주간 단계 카드가 펼쳐집니다.</li>
      </ul>
    </section>

    <section class="card">
      <h3 class="title">1) 빠른 설정</h3>
      <div class="row">
        <div class="field"><label>성별<select id="in-sex"><option value="male">남성</option><option value="female">여성</option></select></label></div>
        <div class="field"><label>나이<select id="in-age"><option value="">선택</option><script>for(let i=16;i<=80;i++)document.write(`<option>${i}</option>`)</script></select></label></div>
        <div class="field"><label>키 (cm)<input id="in-height" type="number" min="120" max="220" inputmode="numeric" /></label></div>
        <div class="field"><label>몸무게 (kg)<input id="in-weight" type="number" min="35" max="120" step="0.1" inputmode="decimal" /></label></div>
      </div>

      <div class="row">
        <div class="field" style="flex:1 1 220px">
          <label>기록 입력(하나만 필요)</label>
          <div class="row">
            <input id="in-10k-m" type="number" min="25" max="80" placeholder="10K 분" style="flex:0 0 90px">
            <span>:</span>
            <input id="in-10k-s" type="number" min="0" max="59" placeholder="10K 초" style="flex:0 0 90px">
            <span class="muted">또는</span>
            <input id="in-hm-h" type="number" min="0" max="3" placeholder="하프 시" style="flex:0 0 80px">
            <span>:</span>
            <input id="in-hm-m" type="number" min="0" max="59" placeholder="하프 분" style="flex:0 0 80px">
            <span>:</span>
            <input id="in-hm-s" type="number" min="0" max="59" placeholder="하프 초" style="flex:0 0 80px">
          </div>
          <div class="muted">예: 10K 40:00 또는 하프 1:28:00</div>
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex:1 1 240px">
          <label>날씨(원터치)</label>
          <div class="chips" id="wx-chips">
            <button class="chip" data-wx="normal" aria-pressed="true">보통</button>
            <button class="chip" data-wx="heat">더위</button>
            <button class="chip" data-wx="cold">추위</button>
            <button class="chip" data-wx="rain">비</button>
            <button class="chip" data-wx="wind">강풍</button>
            <button class="chip adv-only" data-wx="snow">눈·결빙</button>
            <button class="chip adv-only" data-wx="hail">우박·악천후</button>
          </div>
          <select id="in-weather" class="adv-only" style="margin-top:6px">
            <option value="normal" selected>보통</option><option value="heat">더위</option><option value="cold">추위</option>
            <option value="rain">비</option><option value="wind">강풍</option><option value="snow">눈·결빙</option><option value="hail">우박·악천후</option>
          </select>
        </div>
        <div class="field" style="flex:1 1 200px">
          <label>단위</label>
          <div class="chips" id="unit-chips">
            <button class="chip" data-unit="metric" aria-pressed="true">km · 분:초/ km</button>
            <button class="chip" data-unit="imperial">mile · 분:초/ mile</button>
          </div>
          <select id="in-units" class="adv-only" style="margin-top:6px">
            <option value="metric" selected>km · 분:초/ km</option>
            <option value="imperial">mile · 분:초/ mile</option>
          </select>
        </div>
        <div class="field adv-only" style="flex:1 1 220px">
          <label>리겔 지수 모드</label>
          <div class="row">
            <select id="in-riegel-mode" style="flex:1 1 140px">
              <option value="auto" selected>자동</option><option value="manual">수동</option>
            </select>
            <input id="in-riegel" type="number" min="1.03" max="1.10" step="0.01" value="1.06" style="flex:1 1 100px">
          </div>
          <div class="muted">자동: 기록·페이스에 따라 1.04/1.06/1.08</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="title">2) 결과(즉시 계산)</h3>
      <div class="kpi">
        <div class="kpi__item"><div class="kpi__val" id="mp">—</div><div class="kpi__lab">MP (분:초/ 단위)</div></div>
        <div class="kpi__item"><div class="kpi__val" id="easy">—</div><div class="kpi__lab">Easy 범위</div></div>
        <div class="kpi__item"><div class="kpi__val" id="aer">—</div><div class="kpi__lab">Aerobic 범위</div></div>
        <div class="kpi__item"><div class="kpi__val" id="t">—</div><div class="kpi__lab">T(템포) 범위</div></div>
        <div class="kpi__item"><div class="kpi__val" id="cv">—</div><div class="kpi__lab">CV 범위</div></div>
        <div class="kpi__item"><div class="kpi__val" id="fuel">—</div><div class="kpi__lab">영양/수분/Na</div></div>
      </div>
      <div class="muted" style="margin-top:8px">오늘 권장 세션: <span id="today-sess" class="badge">계획대로</span></div>
    </section>

    <section class="card">
      <h3 class="title">3) 주간(간단 프리셋)</h3>
      <div class="tabs" role="tablist" aria-label="주간 프리셋">
        <button class="tbtn" aria-pressed="true" data-preset="base">베이스</button>
        <button class="tbtn" aria-pressed="false" data-preset="spec">스페시픽</button>
        <button class="tbtn" aria-pressed="false" data-preset="taper">테이퍼</button>
        <button class="tbtn adv-only" aria-pressed="false" data-preset="more">상세(모든 단계)</button>
      </div>
      <div id="plan-box" class="muted"></div>
    </section>

    <!-- 상세 주간(모든 단계 카드) -->
    <section id="weekly-advanced" class="card adv-only">
      <h3 class="title">상세 주간(모든 단계)</h3>
      <div class="grid grid--2">
        <div class="card"><h4 class="title">프렙 주</h4>
          <ul class="muted">
            <li>월: Easy 6–10 km + 모빌리티 10분</li>
            <li>화: 언덕 스프린트 8–10회 × 8–12초(워크백 완전회복)</li>
            <li>수: Aerobic 8–12 km</li>
            <li>목: LT 입문 3×8분(세트 사이 2분)</li>
            <li>금: Easy 6–10 km + S&C 20분</li>
            <li>토: Easy 8–12 km</li>
            <li>일: 롱런 14–20 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">베이스1 주</h4>
          <ul class="muted">
            <li>월: Easy 10–14 km + 스트라이드</li>
            <li>화: 언덕 10회 × 60초 또는 CV 5×5분(휴식 2분)</li>
            <li>수: Aerobic 12–16 km</li>
            <li>목: 템포 2×5 km 또는 30–40분</li>
            <li>금: Easy 8–12 km + S&C 25분</li>
            <li>토: Easy 10–14 km</li>
            <li>일: 롱런 24–28 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">베이스2 주</h4>
          <ul class="muted">
            <li>월: 회복 8–12 km</li>
            <li>화: 10×1 km @10K(휴식 60–75초) 또는 CV 6×4분(휴식 2분)</li>
            <li>수: Aerobic 12–16 km + 스트라이드</li>
            <li>목: 템포 2×6 km 또는 35–45분</li>
            <li>금: Easy 8–12 km + S&C 20분</li>
            <li>토: Easy 10–12 km</li>
            <li>일: 롱런 24–30 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">스페시픽1 주</h4>
          <ul class="muted">
            <li>월: 회복 8–12 km</li>
            <li>화: 10×1 km @10K(휴식 60–75초)</li>
            <li>수: Aerobic 14–18 km + 스트라이드</li>
            <li>목: MP 블록 2×(6–8 km) / 세트 사이 2–3 km 조깅</li>
            <li>금: Easy 8–12 km</li>
            <li>토: Easy 10–12 km</li>
            <li>일: 롱런 28–32 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">스페시픽2 주</h4>
          <ul class="muted">
            <li>월: 회복 8–12 km</li>
            <li>화: 5×2 km @10K(휴식 90초) 또는 3×3 km @10K(휴식 2분)</li>
            <li>수: Aerobic 14–18 km + 스트라이드</li>
            <li>목: MP 연속 14–18 km 또는 MP 블록 3×(5–6 km)</li>
            <li>금: Easy 8–12 km</li>
            <li>토: Easy 10–12 km</li>
            <li>일: 롱런 28–32 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">피크-1 주</h4>
          <ul class="muted">
            <li>월: 회복 8–10 km</li>
            <li>화: 6×2 km @10K(휴식 90초) 또는 3×3 km @10K(휴식 2분)</li>
            <li>수: Aerobic 12–16 km</li>
            <li>목: MP 블록 2×(8–10 km) / 세트 사이 2–3 km 조깅</li>
            <li>금: Easy 8–10 km</li>
            <li>토: Easy 8–10 km</li>
            <li>일: 롱런 32–34 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">테이퍼-1 주</h4>
          <ul class="muted">
            <li>월: 회복 6–8 km</li>
            <li>화: 6×1 km(가볍게)</li>
            <li>수: Aerobic 8–12 km</li>
            <li>목: MP 12–16 km</li>
            <li>금: Easy 6–8 km</li>
            <li>토: Easy 6–8 km</li>
            <li>일: 롱런 18–24 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">테이퍼B 주</h4>
          <ul class="muted">
            <li>월: 회복 6–8 km</li>
            <li>화: 5×1 km(가볍게)</li>
            <li>수: Aerobic 8–10 km</li>
            <li>목: MP 8–12 km</li>
            <li>금: Easy 6–8 km</li>
            <li>토: Easy 6–8 km</li>
            <li>일: 롱런 16–22 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">리커버리 주</h4>
          <ul class="muted">
            <li>월: 휴식 또는 걷기/요가 30–45분</li>
            <li>화: Easy 6–10 km</li>
            <li>수: 크로스 40–60분</li>
            <li>목: Easy 8–12 km + 스트라이드</li>
            <li>금: 휴식 또는 Easy 6–8 km</li>
            <li>토: Easy 8–10 km</li>
            <li>일: 롱런 16–22 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
        <div class="card"><h4 class="title">오프·리셋 주</h4>
          <ul class="muted">
            <li>월: 걷기 30–60분</li>
            <li>화: 요가/스트레칭 30분</li>
            <li>수: Easy 조깅 20–40분</li>
            <li>목: 휴식 또는 크로스 30–45분</li>
            <li>금: Easy 조깅 20–40분</li>
            <li>토: 산책/트레일 40–60분</li>
            <li>일: 옵션 롱런 12–16 km <span class="badge lr-badge">0%</span></li>
          </ul>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="title">가이드(핵심)</h3>
      <ul class="list">
        <li><strong>언덕 스프린트</strong>: 6–10회 × 8–12초(경사 6–10%, 워크백 완전회복)</li>
        <li><strong>스트라이드</strong>: 6–10회 × 80–120 m(회당 20–30초 조깅)</li>
        <li><strong>LT 입문</strong>: 3×8분(세트 사이 2분) 또는 4×6분(세트 사이 90초), 하프 페이스 ±0–10초/ km</li>
        <li><strong>템포</strong>: 20–40분, 하프 페이스 ±0–10초/ km</li>
        <li><strong>CV</strong>: 6–8회 × 1 km(휴식 60–75초) 또는 5–6회 × 4분(휴식 2분), 5K +8–12초/ km</li>
        <li><strong>MP 블록</strong>: 2×(6–8 km @MP, 세트 사이 2–3 km 조깅) 또는 연속 12–18 km @MP</li>
      </ul>
    </section>
  </div>

  <!-- 하단 요약바(상세 모드에서만) -->
  <div class="helper" id="quickbar" aria-hidden="true">
    <div class="helper__in">
      <div class="pair"><strong>MP</strong><span id="q-mp">—</span></div>
      <div class="pair"><strong>Easy</strong><span id="q-easy">—</span></div>
      <div class="pair"><strong>T</strong><span id="q-t">—</span></div>
      <div class="pair"><strong>CV</strong><span id="q-cv">—</span></div>
      <div class="pair"><strong>연료</strong><span id="q-fuel">—</span></div>
      <div class="pair"><strong>오늘</strong><span id="q-sess">—</span></div>
      <div style="margin-left:auto" class="row">
        <button class="btn" id="btn-collapse" title="하단바 접기">접기</button>
        <button class="btn" id="btn-copy">복사</button>
        <button class="btn" id="btn-share">공유</button>
      </div>
    </div>
  </div>
  <!-- 접었을 때 작은 버튼(FAB) -->
  <button id="fab-showbar" class="fab" hidden title="요약 보기">▲</button>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = (id) => document.getElementById(id);
      const set = (el, v) => { if(el && el.textContent!==v) el.textContent = v; };
      const KM_PER_MILE = 1.609344;

      // 모드/도움말/퀵바
      const body = document.body, quickbar=$('quickbar'), fab=$('fab-showbar');
      const btnSimple=$('mode-simple'), btnAdv=$('mode-advanced'), helpBtn=$('help-toggle'), helpPanel=$('help-panel');
      const MODE_KEY='sub3_simple';
      function applyMode(simple=true){
        body.classList.toggle('simple', simple);
        btnSimple.setAttribute('aria-pressed', String(simple));
        btnAdv.setAttribute('aria-pressed', String(!simple));
        quickbar.setAttribute('aria-hidden', String(simple));
        fab.hidden = true; // 모드 전환 시 FAB 숨김
      }
      btnSimple.addEventListener('click', ()=>{applyMode(true); try{localStorage.setItem(MODE_KEY,'1')}catch(e){}});
      btnAdv.addEventListener('click', ()=>{applyMode(false);try{localStorage.setItem(MODE_KEY,'0')}catch(e){}});
      (function initMode(){const s=localStorage.getItem(MODE_KEY);applyMode(s!=='0');})();

      helpBtn.addEventListener('click', ()=>{
        const on = helpBtn.getAttribute('aria-pressed')!=='true';
        helpBtn.setAttribute('aria-pressed', String(on));
        helpBtn.setAttribute('aria-expanded', String(on));
        helpPanel.classList.toggle('is-open', on);
        helpPanel.setAttribute('aria-hidden', String(!on));
        if(on) helpPanel.scrollIntoView({behavior:'smooth', block:'nearest'});
      });

      // 간단 프리셋
      const planBox = $('plan-box');
      const PRESETS = {
        base:`- 월: Easy 10–14 km + 스트라이드<br/>- 화: 언덕 10회 × 60초 또는 CV 5회 × 5분(휴식 2분)<br/>- 수: Aerobic 12–16 km<br/>- 목: 템포 2세트 × 5 km 또는 30–40분<br/>- 금: Easy 8–12 km + S&C 25분<br/>- 토: Easy 10–14 km<br/>- 일: 롱런 24–28 km(후반 4–6 km 점증)`,
        spec:`- 화: 10회 × 1 km @10K(휴식 60–75초)<br/>- 목: MP 블록 2세트 × (6–8 km) 또는 MP 14–18 km<br/>- 일: 롱런 28–32 km(후반 8–12 km @MP~MP+10초/ km)`,
        taper:`- 화: 6회 × 1 km(가볍게) · 목: MP 12–16 km · 일: 롱런 18–24 km(편한 페이스)`,
        more:`상세 보기 모드에서 아래 ‘상세 주간(모든 단계)’ 카드가 보입니다.`
      };
      function selectPreset(key){
        document.querySelectorAll('.tbtn').forEach(b=>b.setAttribute('aria-pressed','false'));
        const btn=[...document.querySelectorAll('.tbtn')].find(b=>b.dataset.preset===key);
        if(btn) btn.setAttribute('aria-pressed','true');
        planBox.innerHTML = `<div class="muted">${PRESETS[key]}</div>`;
        if(key==='more'){
          // 상세 모드로 전환하고 상세 섹션으로 스크롤
          document.getElementById('mode-advanced')?.click();
          document.getElementById('weekly-advanced')?.scrollIntoView({behavior:'smooth', block:'start'});
        }
      }
      document.querySelectorAll('.tbtn').forEach(b=>b.addEventListener('click',()=>selectPreset(b.dataset.preset)));
      selectPreset('base');

      // 칩 바인딩
      const els = {
        sex:$('in-sex'), age:$('in-age'), h:$('in-height'), kg:$('in-weight'),
        wx:$('in-weather'), units:$('in-units'),
        rMode:$('in-riegel-mode'), rExp:$('in-riegel'),
        k10m:$('in-10k-m'), k10s:$('in-10k-s'),
        hmH:$('in-hm-h'), hmM:$('in-hm-m'), hmS:$('in-hm-s')
      };
      document.querySelectorAll('#wx-chips .chip').forEach(ch=>{
        ch.addEventListener('click',()=>{
          document.querySelectorAll('#wx-chips .chip').forEach(x=>x.setAttribute('aria-pressed','false'));
          ch.setAttribute('aria-pressed','true'); els.wx.value = ch.dataset.wx; calc();
        });
      });
      document.querySelectorAll('#unit-chips .chip').forEach(ch=>{
        ch.addEventListener('click',()=>{
          document.querySelectorAll('#unit-chips .chip').forEach(x=>x.setAttribute('aria-pressed','false'));
          ch.setAttribute('aria-pressed','true'); els.units.value = ch.dataset.unit; calc();
        });
      });

      // 퀵바 접기/펼치기(FAB)
      $('btn-collapse')?.addEventListener('click', ()=>{
        quickbar.setAttribute('aria-hidden','true');
        if(document.body.classList.contains('simple')) return;
        $('fab-showbar').hidden = false;
      });
      $('fab-showbar')?.addEventListener('click', ()=>{
        quickbar.setAttribute('aria-hidden','false');
        $('fab-showbar').hidden = true;
      });

      // 유틸
      function secToPace(sec){
        if(!isFinite(sec)||sec<=0) return '—';
        const useImp = els.units.value==='imperial';
        const s = Math.round(useImp? sec*KM_PER_MILE : sec);
        const m = Math.floor(s/60), ss=String(s%60).padStart(2,'0');
        return `${m}:${ss}/${useImp?'mile':'km'}`;
      }
      const clamp=(v,a,b)=>Math.min(Math.max(v,a),b);
      const read=(el)=>{const v=parseFloat(el?.value);return Number.isFinite(v)?v:0;};
      function normMS(m,s){let M=Math.max(0,Math.floor(read(m))), S=Math.floor(read(s));if(S<0)S=0;if(S>=60){M+=Math.floor(S/60);S%=60;}return M*60+S;}
      function getExp(p10){const mode=els.rMode?.value||'auto'; if(mode==='manual'){const v=parseFloat(els.rExp?.value); return (v>=1.03&&v<=1.10)?v:1.06;}
        if(!isFinite(p10)||p10<=0) return 1.06; if(p10<=240) return 1.04; if(p10>=330) return 1.08; return 1.06;}

      const WX = {
        normal:{ml:[6,10],na:[300,600],adj:{e:0,a:0,t:0,c:0},lr:[0,0],sess:'계획대로'},
        heat:{ml:[8,12],na:[600,1000],adj:{e:10,a:8,t:12,c:8},lr:[-20,-10],sess:'Aerobic 40–70분(반복 10–20%↓)'},
        cold:{ml:[4,8],na:[300,500],adj:{e:4,a:4,t:6,c:4},lr:[-10,0],sess:'워밍업 길게, 고강도 보수'},
        rain:{ml:[6,10],na:[300,600],adj:{e:5,a:5,t:8,c:5},lr:[-10,0],sess:'템포/인터벌은 실내 고려'},
        wind:{ml:[6,10],na:[300,600],adj:{e:4,a:4,t:6,c:6},lr:[-10,0],sess:'루프 코스, RPE 기준'},
        snow:{ml:[6,10],na:[300,600],adj:{e:12,a:12,t:20,c:15},lr:[-30,-10],sess:'실내 Easy 30–60분 + S&C'},
        hail:{ml:[6,10],na:[300,600],adj:{e:15,a:15,t:25,c:20},lr:[-30,-10],sess:'실내 전환'}
      };

      // 계산
      function calc(){
        const age=parseFloat(els.age.value)||0, masters=age>=40;
        const kg=read(els.kg), h=read(els.h), wx=WX[els.wx.value]||WX.normal;
        const t10=normMS(els.k10m,els.k10s), tHM=(read(els.hmH)||0)*3600 + normMS(els.hmM,els.hmS);
        const D10=10, DHM=21.0975, DM=42.195;

        let p10=0;
        if(t10>0) p10=t10/D10;
        else if(tHM>0) p10=(tHM*Math.pow(D10/DHM,getExp(tHM/DHM)))/D10;

        let mp=0;
        if(tHM>0) mp=(tHM*Math.pow(DM/DHM,getExp(p10||300)))/DM;
        else if(t10>0) mp=(t10*Math.pow(DM/D10,getExp(p10||300)))/DM;

        const adjM={e:masters?5:0,a:masters?5:0,t:masters?5:0,c:masters?3:0}, A=wx.adj;
        const easy = mp? [mp+60+adjM.e+A.e, mp+90+adjM.e+A.e] : null;
        const aer  = mp? [mp+30+adjM.a+A.a, mp+60+adjM.a+A.a] : null;

        let pHM= tHM? tHM/DHM : (p10? (p10*D10)*Math.pow(DHM/D10,getExp(p10))/DHM : 0);
        let p5 =  p10? (p10*D10)*Math.pow(5/D10,getExp(p10))/5 : (tHM? (tHM)*Math.pow(5/DHM,getExp(pHM))/5 : 0);

        const T = (pHM||p10) ? [ (pHM||p10+10)+0 + A.t, (pHM||p10+10)+10 + adjM.t + A.t ] : null;
        const CV= (p5||p10)  ? [ (p5||p10)+8 + A.c, (p5||p10)+12 + adjM.c + A.c ] : null;

        const cho = kg? [clamp(kg*0.8,60,120), clamp(kg*1.0,60,120)] : null;
        const ml=wx.ml, hydr = kg? [clamp(kg*ml[0]/1000,0.3,1.2), clamp(kg*ml[1]/1000,0.3,1.2)] : null;
        const na = wx.na;

        set($('mp'), mp? secToPace(mp) : '—');
        set($('easy'), easy? `${secToPace(easy[0])} ~ ${secToPace(easy[1])}` : '—');
        set($('aer'),  aer?  `${secToPace(aer[0])} ~ ${secToPace(aer[1])}`   : '—');
        set($('t'),    T?    `${secToPace(T[0])} ~ ${secToPace(T[1])}`       : '—');
        set($('cv'),   CV?   `${secToPace(CV[0])} ~ ${secToPace(CV[1])}`     : '—');

        const fuelStr = `${cho? `${Math.round(cho[0])}–${Math.round(cho[1])} g/h` : '60–90 g/h'} · ${hydr? `${hydr[0].toFixed(1)}–${hydr[1].toFixed(1)} L/h` : (wx===WX.heat?'0.6–1.0 L/h':'0.4–0.8 L/h')} · ${na[0]}–${na[1]} mg/h`;
        set($('fuel'), fuelStr);
        set($('today-sess'), wx.sess);

        set($('q-mp'), $('mp').textContent);
        set($('q-easy'), $('easy').textContent);
        set($('q-t'), $('t').textContent);
        set($('q-cv'), $('cv').textContent);
        set($('q-fuel'), fuelStr);
        set($('q-sess'), wx.sess);

        // 상세 주간 롱런 배지 동기화
        const lrTxt = wx.lr[0]===wx.lr[1] ? `${wx.lr[0]}%` : `${wx.lr[0]}%~${wx.lr[1]}%`;
        document.querySelectorAll('.lr-badge').forEach(b=>b.textContent=lrTxt);
      }

      function bindInputs(){
        ['in-sex','in-age','in-height','in-weight','in-weather','in-units','in-riegel-mode','in-riegel','in-10k-m','in-10k-s','in-hm-h','in-hm-m','in-hm-s']
          .forEach(id=>$(id)?.addEventListener('input',calc));
      }

      // 복사/공유
      $('btn-copy')?.addEventListener('click', async ()=>{
        const txt = `MP: ${$('mp').textContent}\nEasy: ${$('easy').textContent}\nT: ${$('t').textContent}\nCV: ${$('cv').textContent}\n연료: ${$('fuel').textContent}\n오늘: ${$('today-sess').textContent}`;
        try{await navigator.clipboard.writeText(txt);}catch(e){prompt('복사하세요',txt);}
      });
      $('btn-share')?.addEventListener('click', async ()=>{
        const data = {
          sex: $('in-sex').value, age:$('in-age').value, h:$('in-height').value, kg:$('in-weight').value, wx:$('in-weather').value,
          units:$('in-units').value, rm:$('in-riegel-mode').value, re:$('in-riegel').value,
          k10m:$('in-10k-m').value, k10s:$('in-10k-s').value, hmH:$('in-hm-h').value, hmM:$('in-hm-m').value, hmS:$('in-hm-s').value
        };
        const url = `${location.origin}${location.pathname}?s=${btoa(encodeURIComponent(JSON.stringify(data)))}`;
        try{await navigator.clipboard.writeText(url);}catch(e){prompt('링크를 복사하세요',url);}
      });

      // 공유 링크 복원
      (function hydrateFromQS(){
        const qs = new URLSearchParams(location.search); const raw = qs.get('s'); if(!raw) return;
        try{
          const d = JSON.parse(decodeURIComponent(atob(raw)));
          Object.entries(d).forEach(([k,v])=>{
            const input = document.querySelector(`#in-${k}`) || document.getElementById(`in-${k}`);
            if(input!=null) input.value = v;
          });
          // 칩 동기화
          document.querySelectorAll('#wx-chips .chip').forEach(x=>x.setAttribute('aria-pressed','false'));
          const wxBtn = document.querySelector(`#wx-chips .chip[data-wx="${$('in-weather').value}"]`); wxBtn?.setAttribute('aria-pressed','true');
          document.querySelectorAll('#unit-chips .chip').forEach(x=>x.setAttribute('aria-pressed','false'));
          const unBtn = document.querySelector(`#unit-chips .chip[data-unit="${$('in-units').value}"]`); unBtn?.setAttribute('aria-pressed','true');
        }catch(e){}
      })();

      // 초기
      bindInputs(); calc();
    });
  </script>
</body>
</html>
