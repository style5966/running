<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <title>Sub-3 통합 프로그램 — 간단/상세 + 타임라인</title>
  <style>
    :root{
      --bg-primary:#0b1220; --bg-secondary:#0f172a; --bg-card:rgba(17,24,39,.6);
      --border-primary:rgba(148,163,184,.25);
      --text-primary:#e5e7eb; --text-muted:#9aa4b2; --text-link:#93c5fd;
      --color-primary:#38bdf8; --color-accent:#a78bfa; --color-success:#34d399; --color-warning:#f59e0b; --color-danger:#ef4444;
      --focus:#93c5fd;
    }
    *,*:before,*:after{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg-primary),var(--bg-secondary));color:var(--text-primary);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif}
    a{color:var(--text-link);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1,h2,h3{margin:0 0 8px}
    p{margin:6px 0}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid--2{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.grid--3{grid-template-columns:repeat(3,1fr)}}
    .card{border:1px solid var(--border-primary);background:var(--bg-card);border-radius:14px;padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .chip{border:1px solid var(--border-primary);color:var(--text-primary);background:rgba(17,24,39,.6);padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none}
    .chip[aria-pressed="true"]{border-color:var(--color-primary);box-shadow:0 0 0 2px rgba(56,189,248,.25) inset}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border-primary);background:rgba(17,24,39,.6);color:var(--text-primary);cursor:pointer}
    .btn:focus-visible,.chip:focus-visible{outline:2px solid var(--focus);outline-offset:2px}
    .field{display:flex;flex-direction:column;gap:4px;min-width:120px}
    .input,.select{padding:10px;border-radius:10px;border:1px solid var(--border-primary);background:#0b1220;color:var(--text-primary)}
    .muted{color:var(--text-muted);font-size:13px}
    .title{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(min-width:700px){.kpi{grid-template-columns:repeat(3,1fr)}}
    .kpi-item{border:1px dashed var(--border-primary);border-radius:12px;padding:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border-primary);border-radius:999px;background:rgba(17,24,39,.6);font-size:12px}
    .mini{font-size:11px;padding:2px 6px;border-radius:999px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .hidden{display:none !important}
    [data-view="simple"] .detail-only{display:none !important}
    [data-view="detail"] .simple-only{display:none !important}
    .evidence-panel{display:none}
    .evidence-panel.is-open{display:block}
    .fab{position:fixed;right:16px;bottom:16px;z-index:50;padding:12px 14px;border-radius:999px;background:rgba(17,24,39,.9);border:1px solid var(--border-primary);color:var(--text-primary);box-shadow:0 6px 22px rgba(0,0,0,.35)}
    /* 프리셋 버튼 잘림 방지 */
    .preset-btn{padding:10px 14px;border-radius:9999px;border:1px solid var(--border-primary);background:rgba(17,24,39,.6);color:var(--text-primary);cursor:pointer}
    .preset-btn[aria-pressed="true"]{border-color:var(--color-accent);box-shadow:0 0 0 2px rgba(167,139,250,.25) inset}
    /* WU/CD */
    .wucd-card{border:1px solid var(--border-primary);border-radius:12px;padding:12px;background:rgba(15,23,42,.5)}
    .wucd-title{margin:0 0 8px;font-size:16px}
    .wucd-vals{display:flex;gap:8px;flex-wrap:wrap}
    .wucd-mini-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    /* 리스트 */
    ul.clean{margin:0;padding-left:18px}
    ul.clean li{margin:6px 0}
    /* 모바일 안전영역 */
    @supports(padding:env(safe-area-inset-bottom)){
      .container{padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    }
  </style>
</head>
<body data-view="simple">
  <div class="container">
    <div class="card">
      <div class="title">
        <h1>Sub-3 통합 프로그램</h1>
        <div class="tabs" role="toolbar" aria-label="보기 전환">
          <button class="btn" id="btn-simple" aria-pressed="true" title="간단 보기">간단</button>
          <button class="btn" id="btn-detail" aria-pressed="false" title="상세 보기">상세</button>
          <button class="btn" id="btn-evidence" aria-pressed="false" title="핵심 문헌">근거</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="muted">단위</span>
        <button class="chip" data-units="metric" aria-pressed="true">km·분:초/ km</button>
        <button class="chip" data-units="imperial" aria-pressed="false">mile·분:초/ mile</button>
        <span class="muted" style="margin-left:8px">날씨</span>
        <button class="chip" data-weather="normal" aria-pressed="true">보통</button>
        <button class="chip" data-weather="hot" aria-pressed="false">더위</button>
        <button class="chip" data-weather="cold" aria-pressed="false">추위</button>
      </div>
    </div>

    <div class="grid grid--2" style="margin-top:12px">
      <div class="card">
        <h2>개인화</h2>
        <div class="row">
          <label class="field" style="flex:1 1 90px">
            <span class="muted">성별</span>
            <select id="in-sex" class="select" aria-label="성별">
              <option value="male">남성</option>
              <option value="female">여성</option>
            </select>
          </label>
          <label class="field" style="flex:1 1 90px">
            <span class="muted">나이(세)</span>
            <input id="in-age" class="input" type="number" min="12" max="85" value="30" />
          </label>
          <label class="field" style="flex:1 1 120px">
            <span class="muted">키(cm)</span>
            <input id="in-height" class="input" type="number" min="120" max="220" value="175" />
          </label>
          <label class="field" style="flex:1 1 120px">
            <span class="muted">체중(kg)</span>
            <input id="in-weight" class="input" type="number" min="35" max="150" value="65" />
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="field" style="flex:1 1 180px">
            <span class="muted">5K 기록(분:초)</span>
            <input id="in-5k" class="input" placeholder="예: 20:30" inputmode="numeric" />
          </div>
          <div class="field" style="flex:1 1 180px">
            <span class="muted">10K 기록(분:초)</span>
            <input id="in-10k" class="input" placeholder="예: 45:00" inputmode="numeric" />
          </div>
          <div class="field" style="flex:1 1 180px">
            <span class="muted">하프(시:분:초)</span>
            <input id="in-hm" class="input" placeholder="예: 1:38:00" inputmode="numeric" />
          </div>
          <div class="field" style="flex:1 1 180px">
            <span class="muted">마라톤(시:분:초)</span>
            <input id="in-m" class="input" placeholder="예: 3:30:00" inputmode="numeric" />
          </div>
        </div>
        <p class="muted">기록은 하나만 입력해도 됩니다. 최신·가장 신뢰 가능한 기록이 자동 반영됩니다.</p>
      </div>

      <div class="card">
        <div class="title">
          <h2>요약(자동 계산)</h2>
          <div class="row">
            <label class="muted"><input type="checkbox" id="toggle-mini-wucd" checked /> 세션별 WU/CD 배지</label>
          </div>
        </div>
        <div class="kpi" style="margin-top:6px">
          <div class="kpi-item"><div class="muted">MP(마라톤 페이스)</div><div id="kpi-mp">—</div></div>
          <div class="kpi-item"><div class="muted">Easy</div><div id="kpi-easy">—</div></div>
          <div class="kpi-item"><div class="muted">Aerobic</div><div id="kpi-aer">—</div></div>
          <div class="kpi-item"><div class="muted">Threshold(T)</div><div id="kpi-t">—</div></div>
          <div class="kpi-item"><div class="muted">CV</div><div id="kpi-cv">—</div></div>
          <div class="kpi-item"><div class="muted">10K</div><div id="kpi-10k">—</div></div>
        </div>
        <div class="kpi" style="margin-top:6px">
          <div class="kpi-item"><div class="muted">CHO</div><div id="kpi-cho">—</div><div class="muted">g/시간</div></div>
          <div class="kpi-item"><div class="muted">물</div><div id="kpi-water">—</div><div class="muted">mL/kg/시간</div></div>
          <div class="kpi-item"><div class="muted">Na</div><div id="kpi-na">—</div><div class="muted">mg/시간</div></div>
          <div class="kpi-item"><div class="muted">단백질</div><div id="kpi-pro">—</div><div class="muted">g(세션 후)</div></div>
        </div>
      </div>
    </div>

    <!-- WU/CD 위젯 -->
    <div class="card wucd-card" id="wucd-widget" role="region" aria-label="워밍업·쿨다운 가이드" style="margin-top:12px">
      <div class="title"><h2 class="wucd-title">워밍업·쿨다운</h2></div>
      <div class="row" style="margin-top:6px">
        <label class="badge" title="세션 선택">세션</label>
        <select id="wucd-type" class="select" aria-label="세션 선택">
          <option value="easy">이지·리커버리</option>
          <option value="tempo">템포(LT)</option>
          <option value="cv">CV/VO2/10K 인터벌</option>
          <option value="hill">언덕 스프린트</option>
          <option value="long">롱런</option>
        </select>
        <div class="wucd-vals" aria-live="polite">
          <span class="badge"><strong>WU</strong> <span id="wucd-wu">—</span></span>
          <span class="badge"><strong>CD</strong> <span id="wucd-cd">—</span></span>
        </div>
      </div>
      <div class="wucd-mini-row" aria-label="스트라이드·드릴 요약">
        <span class="badge">스트라이드: 4–8회 × 80–120 m(20–30초)</span>
        <span class="badge">드릴: A‑skip / B‑skip / 하이니 / 버트킥(각 20–30 m)</span>
      </div>
      <p class="muted" style="margin-top:6px">추위: WU +5~10분, 더위: WU 5–8분(짧게) 권장.</p>
    </div>

    <!-- 영양 타임라인 -->
    <div class="card" id="card-nutri" style="margin-top:12px">
      <div class="title">
        <h2>영양 타임라인</h2>
        <div class="row">
          <button class="chip" data-nmode="train" aria-pressed="true">훈련</button>
          <button class="chip" data-nmode="race" aria-pressed="false">시합</button>
        </div>
      </div>

      <!-- 훈련 모드 -->
      <div id="nutri-train" style="margin-top:8px">
        <div class="row" style="margin-bottom:6px">
          <label class="badge">세션 시간</label>
          <select id="train-duration" class="select" aria-label="세션 시간(분)">
            <option value="45">45분</option>
            <option value="60">60분</option>
            <option value="75">75분</option>
            <option value="90" selected>90분</option>
            <option value="120">120분</option>
            <option value="150">150분</option>
            <option value="180">180분</option>
          </select>
          <span class="muted">날씨/체중을 반영해 총량을 자동 계산합니다.</span>
        </div>
        <div class="grid grid--3">
          <div class="card">
            <h3>훈련 전(2–3시간 전)</h3>
            <ul class="clean">
              <li>탄수화물: <strong id="nt-tr-pre-cho">—</strong></li>
              <li>수분: <strong id="nt-tr-pre-water">—</strong></li>
              <li class="muted">참고: 필요 시 Na 300–600 mg</li>
            </ul>
          </div>
          <div class="card">
            <h3>훈련 중</h3>
            <ul class="clean">
              <li>CHO: <strong id="nt-tr-dur-cho-hr">—</strong> /시간 → 총 <strong id="nt-tr-dur-cho-total">—</strong></li>
              <li>물: <strong id="nt-tr-dur-water-hr">—</strong> → 총 <strong id="nt-tr-dur-water-total">—</strong></li>
              <li>Na: <strong id="nt-tr-dur-na-hr">—</strong> → 총 <strong id="nt-tr-dur-na-total">—</strong></li>
              <li>겔: <strong id="nt-tr-dur-gels">—</strong> · 보틀: <strong id="nt-tr-dur-bottles">—</strong></li>
            </ul>
          </div>
          <div class="card">
            <h3>훈련 후(30–60분)</h3>
            <ul class="clean">
              <li>CHO: <strong id="nt-tr-post-cho">—</strong></li>
              <li>단백질: <strong id="nt-tr-post-pro">—</strong></li>
              <li class="muted">수분: 체중 감소 1 kg 당 1–1.5 L</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 시합 모드 -->
      <div id="nutri-race" class="hidden" style="margin-top:8px">
        <div class="row">
          <span class="badge">예상 완주: <strong id="nt-ra-dur-time">—</strong></span>
          <span class="muted">기록 입력 시 자동 계산(리겔)</span>
        </div>
        <div class="grid grid--3" style="margin-top:8px">
          <div class="card">
            <h3>전날/전전날(36–48시간)</h3>
            <ul class="clean">
              <li>탄수 로딩: <strong id="nt-ra-pre-load">—</strong> /일</li>
              <li class="muted">지방·섬유 낮추고 소화 잘되는 식단</li>
            </ul>
          </div>
          <div class="card">
            <h3>시합 당일(2–3시간 전)</h3>
            <ul class="clean">
              <li>CHO: <strong id="nt-ra-pre-morn-cho">—</strong></li>
              <li>수분: <strong id="nt-ra-pre-morn-water">—</strong></li>
              <li class="muted">필요 시 소량 Na</li>
            </ul>
          </div>
          <div class="card">
            <h3>시합 중</h3>
            <ul class="clean">
              <li>CHO: <strong id="nt-ra-dur-cho-hr">—</strong> → 총 <strong id="nt-ra-dur-cho-total">—</strong></li>
              <li>물: <strong id="nt-ra-dur-water-hr">—</strong> → 총 <strong id="nt-ra-dur-water-total">—</strong></li>
              <li>Na: <strong id="nt-ra-dur-na-hr">—</strong> → 총 <strong id="nt-ra-dur-na-total">—</strong></li>
              <li>겔: <strong id="nt-ra-dur-gels">—</strong> · 보틀: <strong id="nt-ra-dur-bottles">—</strong></li>
            </ul>
          </div>
          <div class="card">
            <h3>시합 후(30–60분)</h3>
            <ul class="clean">
              <li>CHO: <strong id="nt-ra-post-cho">—</strong></li>
              <li>단백질: <strong id="nt-ra-post-pro">—</strong></li>
              <li class="muted">수분: 결손의 150% 보충 권장</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- 상세/주간 -->
    <div class="card" id="panel-weekly" style="margin-top:12px">
      <div class="title">
        <h2>주간 템플릿</h2>
        <div class="row">
          <button class="preset-btn" data-preset="prep" aria-pressed="true">프렙</button>
          <button class="preset-btn" data-preset="base2" aria-pressed="false">베이스2</button>
          <button class="preset-btn" data-preset="spec2" aria-pressed="false">스페시픽2</button>
          <button class="preset-btn" data-preset="peak" aria-pressed="false">피크</button>
          <button class="preset-btn" data-preset="taperb" aria-pressed="false">테이퍼B</button>
          <button class="preset-btn" data-preset="recovery" aria-pressed="false">리커버리</button>
          <button class="preset-btn" data-preset="off" aria-pressed="false">오프·리셋</button>
          <button class="btn detail-only" id="btn-toggle-all" aria-pressed="true" title="상세(모든 단계) 토글">상세(모든 단계)</button>
        </div>
      </div>

      <div id="week-simple" class="simple-only" style="margin-top:8px">
        <ul class="clean" id="week-list"></ul>
      </div>

      <div id="week-all" class="detail-only" style="margin-top:10px">
        <div class="grid grid--2">
          <div class="card">
            <h3>프렙</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 6–10 km</li>
              <li data-s="hill">화: 언덕 스프린트 6–10회 × 10–12초(전 스트라이드 2–4회)</li>
              <li data-s="aer">수: Aerobic 8–12 km</li>
              <li data-s="tempo">목: LT 입문 3×8분(회복 2분)</li>
              <li data-s="easy">금: Easy 6–10 km + 스트라이드</li>
              <li data-s="long">토: 롱런 16–22 km</li>
              <li data-s="rest">일: 휴식/걷기</li>
            </ul>
          </div>
          <div class="card">
            <h3>베이스2</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 8–10 km</li>
              <li data-s="cv">화: CV 6–8회 × 1 km(회복 60–75초)</li>
              <li data-s="aer">수: Aerobic 10–14 km</li>
              <li data-s="tempo">목: 템포 2×20분(회복 3분)</li>
              <li data-s="easy">금: Easy 8–10 km + 스트라이드</li>
              <li data-s="long">토: 롱런 22–28 km</li>
              <li data-s="rest">일: 휴식/보강</li>
            </ul>
          </div>
          <div class="card">
            <h3>스페시픽2</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 8–10 km</li>
              <li data-s="mp">화: MP 블록 2세트 × (6–8 km @ MP)</li>
              <li data-s="aer">수: Aerobic 10–14 km</li>
              <li data-s="tempo">목: 템포 30–40분</li>
              <li data-s="easy">금: Easy 8–10 km + 스트라이드</li>
              <li data-s="long">토: Prog 롱런 26–34 km</li>
              <li data-s="rest">일: 휴식</li>
            </ul>
          </div>
          <div class="card">
            <h3>피크</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 8–10 km</li>
              <li data-s="cv">화: CV 5–6회 × 4분(회복 2분)</li>
              <li data-s="aer">수: Aerobic 10–12 km</li>
              <li data-s="mp">목: MP 연속 12–16 km</li>
              <li data-s="easy">금: Easy 6–8 km</li>
              <li data-s="long">토: 롱런 24–30 km</li>
              <li data-s="rest">일: 휴식</li>
            </ul>
          </div>
          <div class="card">
            <h3>테이퍼B</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 6–8 km</li>
              <li data-s="tempo">화: 템포 2×10분</li>
              <li data-s="easy">수: Easy 6–8 km</li>
              <li data-s="cv">목: 3–4×1 km @ 10K</li>
              <li data-s="easy">금: Easy 5–6 km</li>
              <li data-s="easy">토: Easy 4–6 km + 스트라이드</li>
              <li data-s="rest">일: 휴식</li>
            </ul>
          </div>
          <div class="card">
            <h3>리커버리</h3>
            <ul class="clean">
              <li data-s="easy">월: Easy 5–8 km</li>
              <li data-s="rest">화: 휴식/걷기</li>
              <li data-s="easy">수: Easy 6–8 km</li>
              <li data-s="easy">목: Easy 6–8 km</li>
              <li data-s="easy">금: Easy 5–8 km</li>
              <li data-s="long">토: 롱런 14–18 km</li>
              <li data-s="rest">일: 휴식</li>
            </ul>
          </div>
          <div class="card">
            <h3>오프·리셋</h3>
            <ul class="clean">
              <li data-s="rest">월: 오프/걷기</li>
              <li data-s="rest">화: 오프/요가</li>
              <li data-s="easy">수: Easy 5–6 km(있다면)</li>
              <li data-s="rest">목: 오프</li>
              <li data-s="easy">금: Easy 5–6 km</li>
              <li data-s="rest">토: 오프</li>
              <li data-s="rest">일: 오프</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- 근거 패널 -->
    <div id="panel-evidence" class="card evidence-panel" aria-live="polite" style="margin-top:12px">
      <h2>근거(핵심 문헌)</h2>
      <ol class="clean">
        <li>Stöggl T, Sperlich B. The Training Characteristics of World-Class Distance Runners. Sports Med. 2023.</li>
        <li>Bossi AH, et al. Factors Influencing Running Performance During a Marathon. Sports Med. 2022.</li>
        <li>Trexler ET, et al. Contemporary Nutrition Strategies for Distance Runners. World Athletics, 2022.</li>
        <li>Ojanen T, et al. Quantitative Analysis of Sub-Elite Marathon Training Plans. 2023–2024.</li>
        <li>Bosquet L, et al. Strength Training and Running Economy: Systematic Review. 2024.</li>
        <li>Ardigò LP, et al. Lactate Threshold Post-analysis Methods Depend on Intensity. 2023.</li>
        <li>de Lucas RD, et al. Physiological and Training Characteristics of Recreational Marathoners. 2017.</li>
        <li>Ahmetov II, et al. Genes and Elite Marathon Performance: Systematic Review. 2019.</li>
      </ol>
      <p class="muted">요약: 주 2 품질+롱런, 역치·CV, CHO 60–90 g/h(적응 시 90–120), 물 0.4–0.8 L/h, Na 300–600 mg/h(더위 상향), 단백질 0.3–0.4 g/kg(세션 후).</p>
    </div>
  </div>

  <button id="fab-open" class="fab hidden" aria-label="상단으로">상단</button>

  <script>
  (function(){
    'use strict';
    const root = document.body;

    const state = {
      units:'metric', weather:'normal',
      sex:'male', age:30, height:175, weight:65,
      rec5k:'', rec10k:'', recHM:'', recM:'',
      showMiniWUCD:true, detail:false, showAll:true, evidence:false,
      nmode:'train', trainDurMin:90
    };

    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    const els = {
      chipsUnits: $$('[data-units]'),
      chipsWeather: $$('[data-weather]'),
      chipsNmode: $$('[data-nmode]'),
      btnSimple: $('#btn-simple'),
      btnDetail: $('#btn-detail'),
      btnEvidence: $('#btn-evidence'),
      panelEvidence: $('#panel-evidence'),
      kpi:{ mp:$('#kpi-mp'), easy:$('#kpi-easy'), aer:$('#kpi-aer'), t:$('#kpi-t'), cv:$('#kpi-cv'), k10:$('#kpi-10k'),
            cho:$('#kpi-cho'), water:$('#kpi-water'), na:$('#kpi-na'), pro:$('#kpi-pro') },
      inputs:{
        sex:$('#in-sex'), age:$('#in-age'), height:$('#in-height'), weight:$('#in-weight'),
        rec5k:$('#in-5k'), rec10k:$('#in-10k'), recHM:$('#in-hm'), recM:$('#in-m')
      },
      wucd:{ type:$('#wucd-type'), wu:$('#wucd-wu'), cd:$('#wucd-cd') },
      weekList: $('#week-list'),
      weekAll: $('#week-all'),
      btnToggleAll: $('#btn-toggle-all'),
      toggleMini: $('#toggle-mini-wucd'),
      fabOpen: $('#fab-open'),
      nutri:{
        cardTrain: $('#nutri-train'),
        cardRace: $('#nutri-race'),
        selDur: $('#train-duration')
      }
    };

    const pad2=n=>String(n).padStart(2,'0');
    const setText=(el,txt)=>{ if(el && el.textContent!==txt) el.textContent=txt; };
    const setById=(id,txt)=>{ const el=document.getElementById(id); if(el && el.textContent!==txt) el.textContent=txt; };

    function parseTimeToSec(v){
      if(!v) return 0;
      const s=String(v).trim(); if(!s) return 0;
      const p=s.split(':').map(x=>parseInt(x,10));
      if(p.some(isNaN)) return 0;
      if(p.length===1) return p[0]*60;
      if(p.length===2) return p[0]*60 + p[1];
      if(p.length===3) return p[0]*3600 + p[1]*60 + p[2];
      return 0;
    }
    function secToHMS(sec){
      sec=Math.round(sec);
      const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
      return h?(`${h}:${pad2(m)}:${pad2(s)}`):(`${m}:${pad2(s)}`);
    }
    function paceStrFromKm(secPerKm){
      if(!secPerKm || secPerKm<=0) return '—';
      const secPerUnit = state.units==='metric' ? secPerKm : secPerKm*1.609344;
      const total = Math.round(secPerUnit);
      const m = Math.floor(total/60), s = total%60;
      return `${m}:${pad2(s)}/${state.units==='metric'?'km':'mile'}`;
    }
    function riegel(T1,D1,D2,k=1.06){ return T1*Math.pow(D2/D1,k); }

    const weatherAdj = {
      normal:{ pace:+0, water:1.0, na:1.0 },
      hot:{ pace:+8, water:1.3, na:1.3 },
      cold:{ pace:+0, water:0.9, na:1.0 }
    };

    function computePaces(){
      const t5=parseTimeToSec(state.rec5k);
      const t10=parseTimeToSec(state.rec10k);
      const tHM=parseTimeToSec(state.recHM);
      const tM=parseTimeToSec(state.recM);
      let baseT=0, baseD=0;
      if(tM){ baseT=tM; baseD=42.195; }
      else if(tHM){ baseT=tHM; baseD=21.0975; }
      else if(t10){ baseT=t10; baseD=10; }
      else if(t5){ baseT=t5; baseD=5; }
      const k = (state.age>=40)?1.065:1.06;
      let predM=0, predHM=0, pred10=0, pred5=0;
      if(baseT>0){
        predM = (baseD===42.195)?baseT : riegel(baseT, baseD, 42.195, k);
        predHM = (baseD===21.0975)?baseT : riegel(baseT, baseD, 21.0975, k);
        pred10 = (baseD===10)?baseT : riegel(baseT, baseD, 10, k);
        pred5  = (baseD===5)?baseT : riegel(baseT, baseD, 5, k);
      }
      let mpSecPerKm = predM? (predM/42.195) : 0;
      const w=weatherAdj[state.weather]||weatherAdj.normal;
      if(mpSecPerKm>0) mpSecPerKm += w.pace;
      const hmPace = predHM? (predHM/21.0975):0;
      const k10Pace= pred10? (pred10/10):0;
      const k5Pace = pred5? (pred5/5):0;
      const easy = mpSecPerKm? [mpSecPerKm+50, mpSecPerKm+80] : [0,0];
      const aerobic = mpSecPerKm? [mpSecPerKm+25, mpSecPerKm+45] : [0,0];
      const tPace = hmPace? [hmPace-0, hmPace+10] : [0,0];
      const cvPace = k5Pace? [k5Pace+8, k5Pace+12] : [0,0];
      return { mp:mpSecPerKm, easy, aerobic, t:tPace, cv:cvPace, k10:k10Pace, pred:{M:predM, HM:predHM} };
    }

    function computeNutrition(){
      const w=weatherAdj[state.weather]||weatherAdj.normal;
      const cho=[60,90];
      const waterBase=[6,10]; // mL/kg/h
      const na=[300,600]; // mg/h
      const water=[Math.round(waterBase[0]*w.water), Math.round(waterBase[1]*w.water)];
      const naRec=[Math.round(na[0]*w.na), Math.round(na[1]*w.na)];
      const proPost = Math.round(state.weight*0.35);
      return { cho, water, na:naRec, proPost };
    }

    function render(){
      const P=computePaces();
      const N=computeNutrition();
      setText(els.kpi.mp, P.mp? paceStrFromKm(P.mp):'—');
      setText(els.kpi.easy, P.easy[0]? `${paceStrFromKm(P.easy[0])} ~ ${paceStrFromKm(P.easy[1])}`:'—');
      setText(els.kpi.aer, P.aerobic[0]? `${paceStrFromKm(P.aerobic[0])} ~ ${paceStrFromKm(P.aerobic[1])}`:'—');
      setText(els.kpi.t, P.t[0]? `${paceStrFromKm(P.t[0])} ~ ${paceStrFromKm(P.t[1])}`:'—');
      setText(els.kpi.cv, P.cv[0]? `${paceStrFromKm(P.cv[0])} ~ ${paceStrFromKm(P.cv[1])}`:'—');
      setText(els.kpi.k10, P.k10? paceStrFromKm(P.k10):'—');
      setText(els.kpi.cho, `${N.cho[0]}–${N.cho[1]}`);
      setText(els.kpi.water, `${N.water[0]}–${N.water[1]}`);
      setText(els.kpi.na, `${N.na[0]}–${N.na[1]}`);
      setText(els.kpi.pro, `${N.proPost}`);
      applyWUCD(els.wucd.type.value);
      annotateMiniBadges();
      updateNutritionTimeline(P, N);
    }

    const WUCD_BASE = {
      easy:{wu:[5,8], cd:[5,8]},
      tempo:{wu:[10,15], cd:[10,15]},
      cv:{wu:[15,20], cd:[10,15]},
      hill:{wu:[10,15], cd:[8,12]},
      long:{wu:[8,10], cd:[5,10]},
      aer:{wu:[8,12], cd:[5,10]},
      mp:{wu:[10,15], cd:[8,12]},
      rest:{wu:[0,0], cd:[0,0]}
    };
    function rangeStr(r){ return r[0]===0 && r[1]===0 ? '—' : `${r[0]}–${r[1]}분`; }
    function adjustByWeather(r,type){
      const w=state.weather; let [a,b]=r;
      if(type==='wu'){
        if(w==='cold'){ a+=5; b+=5; }
        if(w==='hot'){ a=Math.max(5,a-2); b=Math.max(8,b-2); }
      }
      return [a,b];
    }
    function applyWUCD(kind){
      const base=WUCD_BASE[kind]||WUCD_BASE.easy;
      const wu=adjustByWeather([...base.wu],'wu');
      const cd=[...base.cd];
      setText(els.wucd.wu, rangeStr(wu));
      setText(els.wucd.cd, rangeStr(cd));
    }
    function annotateMiniBadges(){
      const show=state.showMiniWUCD;
      const targets = Array.from(document.querySelectorAll('[data-s]'));
      targets.forEach(li=>{
        const ex = li.querySelector('.wucd-mini'); if(ex) ex.remove();
        if(!show) return;
        const key = li.getAttribute('data-s');
        const base=WUCD_BASE[key]||WUCD_BASE.easy;
        const wu=adjustByWeather([...base.wu],'wu'), cd=[...base.cd];
        if(base.wu[0]===0 && base.cd[0]===0) return;
        const span=document.createElement('span');
        span.className='badge mini wucd-mini'; span.style.marginLeft='6px';
        span.textContent=`WU ${wu[0]}–${wu[1]} · CD ${cd[0]}–${cd[1]}`;
        li.appendChild(span);
      });
    }

    function fmt1(n){ return (Math.round(n*10)/10).toFixed(1); }

    function updateNutritionTimeline(P, N){
      const w = state.weight||0;
      // 훈련 - 전
      setById('nt-tr-pre-cho', w? `${Math.round(w*1)}–${Math.round(w*3)} g`:'—');
      setById('nt-tr-pre-water', w? `${Math.round(w*5)}–${Math.round(w*7)} mL`:'—');
      // 훈련 - 중
      const minutes = state.trainDurMin||90; const hrs = minutes/60;
      setById('nt-tr-dur-cho-hr', `${N.cho[0]}–${N.cho[1]} g/시간`);
      setById('nt-tr-dur-cho-total', `${Math.round(N.cho[0]*hrs)}–${Math.round(N.cho[1]*hrs)} g`);
      const waterHrLlo = (N.water[0]*w)/1000, waterHrLhi = (N.water[1]*w)/1000;
      setById('nt-tr-dur-water-hr', `${N.water[0]}–${N.water[1]} mL/kg/시간`);
      setById('nt-tr-dur-water-total', w? `${fmt1(waterHrLlo*hrs)}–${fmt1(waterHrLhi*hrs)} L`:'—');
      setById('nt-tr-dur-na-hr', `${N.na[0]}–${N.na[1]} mg/시간`);
      setById('nt-tr-dur-na-total', `${Math.round(N.na[0]*hrs)}–${Math.round(N.na[1]*hrs)} mg`);
      setById('nt-tr-dur-gels', `${Math.round(N.cho[0]*hrs/25)}–${Math.round(N.cho[1]*hrs/25)} 개(25 g)`);
      setById('nt-tr-dur-bottles', w? `${Math.round((waterHrLlo*hrs)/0.5)}–${Math.round((waterHrLhi*hrs)/0.5)} 개(500 mL)`:'—');
      // 훈련 - 후
      setById('nt-tr-post-cho', w? `${Math.round(w*1.0)}–${Math.round(w*1.2)} g`:'—');
      setById('nt-tr-post-pro', w? `${Math.round(w*0.3)}–${Math.round(w*0.4)} g`:'—');

      // 시합
      const sec = P.pred.M||0; const H = sec? (sec/3600):0;
      setById('nt-ra-dur-time', sec? secToHMS(sec):'—');
      setById('nt-ra-pre-load', w? `${Math.round(w*8)}–${Math.round(w*12)} g/일`:'—');
      setById('nt-ra-pre-morn-cho', w? `${Math.round(w*1)}–${Math.round(w*3)} g`:'—');
      setById('nt-ra-pre-morn-water', w? `${Math.round(w*5)}–${Math.round(w*7)} mL`:'—');
      setById('nt-ra-dur-cho-hr', `${N.cho[0]}–${N.cho[1]} g/시간`);
      setById('nt-ra-dur-water-hr', `${N.water[0]}–${N.water[1]} mL/kg/시간`);
      setById('nt-ra-dur-na-hr', `${N.na[0]}–${N.na[1]} mg/시간`);
      if(H){
        setById('nt-ra-dur-cho-total', `${Math.round(N.cho[0]*H)}–${Math.round(N.cho[1]*H)} g`);
        setById('nt-ra-dur-water-total', w? `${fmt1(waterHrLlo*H)}–${fmt1(waterHrLhi*H)} L`:'—');
        setById('nt-ra-dur-na-total', `${Math.round(N.na[0]*H)}–${Math.round(N.na[1]*H)} mg`);
        setById('nt-ra-dur-gels', `${Math.round(N.cho[0]*H/25)}–${Math.round(N.cho[1]*H/25)} 개(25 g)`);
        setById('nt-ra-dur-bottles', w? `${Math.round((waterHrLlo*H)/0.5)}–${Math.round((waterHrLhi*H)/0.5)} 개(500 mL)`:'—');
      }else{
        ['nt-ra-dur-cho-total','nt-ra-dur-water-total','nt-ra-dur-na-total','nt-ra-dur-gels','nt-ra-dur-bottles'].forEach(id=>setById(id,'—'));
      }
      setById('nt-ra-post-cho', w? `${Math.round(w*1.0)}–${Math.round(w*1.2)} g`:'—');
      setById('nt-ra-post-pro', w? `${Math.round(w*0.3)}–${Math.round(w*0.4)} g`:'—');
    }

    // 프리셋
    const PRESETS={
      prep:[{t:'월: Easy 6–10 km',s:'easy'},{t:'화: 언덕 스프린트 6–10회 × 10–12초',s:'hill'},{t:'수: Aerobic 8–12 km',s:'aer'},{t:'목: LT 입문 3×8분(회복 2분)',s:'tempo'},{t:'금: Easy 6–10 km + 스트라이드',s:'easy'},{t:'토: 롱런 16–22 km',s:'long'},{t:'일: 휴식/걷기',s:'rest'}],
      base2:[{t:'월: Easy 8–10 km',s:'easy'},{t:'화: CV 6–8회 × 1 km(회복 60–75초)',s:'cv'},{t:'수: Aerobic 10–14 km',s:'aer'},{t:'목: 템포 2×20분(회복 3분)',s:'tempo'},{t:'금: Easy 8–10 km + 스트라이드',s:'easy'},{t:'토: 롱런 22–28 km',s:'long'},{t:'일: 휴식/보강',s:'rest'}],
      spec2:[{t:'월: Easy 8–10 km',s:'easy'},{t:'화: MP 블록 2세트 × (6–8 km @ MP)',s:'mp'},{t:'수: Aerobic 10–14 km',s:'aer'},{t:'목: 템포 30–40분',s:'tempo'},{t:'금: Easy 8–10 km + 스트라이드',s:'easy'},{t:'토: Prog 롱런 26–34 km',s:'long'},{t:'일: 휴식',s:'rest'}],
      peak:[{t:'월: Easy 8–10 km',s:'easy'},{t:'화: CV 5–6회 × 4분(회복 2분)',s:'cv'},{t:'수: Aerobic 10–12 km',s:'aer'},{t:'목: MP 연속 12–16 km',s:'mp'},{t:'금: Easy 6–8 km',s:'easy'},{t:'토: 롱런 24–30 km',s:'long'},{t:'일: 휴식',s:'rest'}],
      taperb:[{t:'월: Easy 6–8 km',s:'easy'},{t:'화: 템포 2×10분',s:'tempo'},{t:'수: Easy 6–8 km',s:'easy'},{t:'목: 3–4×1 km @ 10K',s:'cv'},{t:'금: Easy 5–6 km',s:'easy'},{t:'토: Easy 4–6 km + 스트라이드',s:'easy'},{t:'일: 휴식',s:'rest'}],
      recovery:[{t:'월: Easy 5–8 km',s:'easy'},{t:'화: 휴식/걷기',s:'rest'},{t:'수: Easy 6–8 km',s:'easy'},{t:'목: Easy 6–8 km',s:'easy'},{t:'금: Easy 5–8 km',s:'easy'},{t:'토: 롱런 14–18 km',s:'long'},{t:'일: 휴식',s:'rest'}],
      off:[{t:'월: 오프/걷기',s:'rest'},{t:'화: 오프/요가',s:'rest'},{t:'수: Easy 5–6 km(있다면)',s:'easy'},{t:'목: 오프',s:'rest'},{t:'금: Easy 5–6 km',s:'easy'},{t:'토: 오프',s:'rest'},{t:'일: 오프',s:'rest'}]
    };
    function renderPreset(name){
      const list = PRESETS[name]||PRESETS.prep;
      els.weekList.innerHTML='';
      list.forEach(item=>{
        const li=document.createElement('li');
        li.textContent=item.t;
        li.setAttribute('data-s', item.s);
        els.weekList.appendChild(li);
      });
      annotateMiniBadges();
    }

    // 보기 전환
    function applyView(){
      root.setAttribute('data-view', state.detail?'detail':'simple');
      if(state.detail){
        state.showAll = true;
        els.btnToggleAll?.setAttribute('aria-pressed','true');
        els.weekAll?.classList.remove('hidden');
      }
    }

    // 이벤트
    $$('.chip[data-units]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.chip[data-units]').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.units=btn.getAttribute('data-units');
        render();
      });
    });
    $$('.chip[data-weather]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.chip[data-weather]').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.weather=btn.getAttribute('data-weather');
        render();
      });
    });
    $$('.chip[data-nmode]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.chip[data-nmode]').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.nmode=btn.getAttribute('data-nmode');
        els.nutri.cardTrain.classList.toggle('hidden', state.nmode!=='train');
        els.nutri.cardRace.classList.toggle('hidden', state.nmode!=='race');
      });
    });

    els.btnSimple.addEventListener('click',()=>{
      state.detail=false;
      els.btnSimple.setAttribute('aria-pressed','true');
      els.btnDetail.setAttribute('aria-pressed','false');
      applyView(); window.scrollTo({top:0,behavior:'smooth'});
    });
    els.btnDetail.addEventListener('click',()=>{
      state.detail=true;
      els.btnSimple.setAttribute('aria-pressed','false');
      els.btnDetail.setAttribute('aria-pressed','true');
      applyView(); window.scrollTo({top:0,behavior:'smooth'});
    });
    els.btnEvidence.addEventListener('click',()=>{
      state.evidence=!state.evidence;
      els.btnEvidence.setAttribute('aria-pressed', String(state.evidence));
      els.panelEvidence.classList.toggle('is-open', state.evidence);
      if(state.evidence){ els.panelEvidence.setAttribute('tabindex','-1'); els.panelEvidence.focus({preventScroll:true}); }
    });
    els.btnToggleAll?.addEventListener('click',()=>{
      state.showAll=!state.showAll;
      els.btnToggleAll.setAttribute('aria-pressed', String(state.showAll));
      els.weekAll.classList.toggle('hidden', !state.showAll);
      annotateMiniBadges();
    });
    els.toggleMini.addEventListener('change',()=>{
      state.showMiniWUCD = els.toggleMini.checked;
      annotateMiniBadges();
    });
    Object.values(els.inputs).forEach(inp=>{
      inp.addEventListener('input', debounce(()=>{
        state.sex=els.inputs.sex.value;
        state.age=parseInt(els.inputs.age.value||'30',10);
        state.height=parseFloat(els.inputs.height.value||'175');
        state.weight=parseFloat(els.inputs.weight.value||'65');
        state.rec5k=els.inputs.rec5k.value;
        state.rec10k=els.inputs.rec10k.value;
        state.recHM=els.inputs.recHM.value;
        state.recM=els.inputs.recM.value;
        render();
      },200));
    });
    els.wucd.type.addEventListener('change',()=>applyWUCD(els.wucd.type.value));
    els.nutri.selDur.addEventListener('change',()=>{
      state.trainDurMin = parseInt(els.nutri.selDur.value,10)||90;
      render();
    });

    // 초기
    $$('.preset-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.preset-btn').forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        renderPreset(b.getAttribute('data-preset'));
      });
    });
    renderPreset('prep');
    applyView();
    render();

    // FAB: 상단으로
    let fabTimer=null;
    window.addEventListener('scroll',()=>{
      const show = window.scrollY>400;
      els.fabOpen.classList.toggle('hidden', !show);
      if(show){ clearTimeout(fabTimer); fabTimer=setTimeout(()=>{},300); }
    });
    els.fabOpen.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));

    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms); }; }
  })();
  </script>
</body>
</html>
