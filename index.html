<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>개선된 Sub-3 통합 프로그램 v4.0 — 인터랙티브·접근성 강화 UI</title>
  <style>
    :root{
      --bg-primary: #0b1220; --bg-secondary: #0f172a; --bg-card: rgba(17,24,39,.6); --bg-blur: rgba(11,18,32,.7);
      --border-primary: rgba(148,163,184,.25);
      --text-primary: #e5e7eb; --text-muted: #9aa4b2; --text-link: #93c5fd;
      --color-primary: #38bdf8; --color-accent: #a78bfa; --color-success: #34d399; --color-warning: #f59e0b; --color-danger: #ef4444;
      --font-size-base: 16px; --line-height-base: 1.6;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin:0; color:var(--text-primary); font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif;
      font-size: var(--font-size-base); line-height: var(--line-height-base);
      background-color: var(--bg-primary);
      background-image:
        radial-gradient(1200px 600px at 20% -10%, rgba(56, 189, 248, .15), transparent 60%),
        radial-gradient(1000px 500px at 120% 10%, rgba(167, 139, 250, .12), transparent 60%),
        linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .skip-link { position:absolute; left:-999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus { position:fixed; left:16px; top:12px; width:auto; height:auto; padding:8px 12px; background:#111827; color:#fff; z-index:1000; border-radius:8px; outline:2px solid var(--color-accent); }

    .container { max-width: 1080px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; gap: 16px; }
    @media(min-width: 900px){
      .grid--2-cols { grid-template-columns: repeat(2, 1fr); }
      .grid--3-cols { grid-template-columns: repeat(3, 1fr); }
      .grid--4-cols { grid-template-columns: repeat(4, 1fr); }
      .cols-2 { columns: 2; gap: 24px; }
    }

    .hero { position: relative; padding: 28px; border: 1px solid var(--border-primary); border-radius: 16px; background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); overflow: hidden; }
    .hero::before { content:""; position:absolute; inset:-2px; background: radial-gradient(400px 120px at 0% 0%, rgba(56,189,248,.12), transparent 60%); }
    .hero__title { margin: 0 0 10px; font-size: 28px; }
    .hero__subtitle { margin: 0; color: var(--text-muted); }
    .hero__tags { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .hero__tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border-primary); font-size: 12px; background: rgba(15,23,42,.6); }
    .hero__tag i { font-style: normal; opacity: .9; }

    .tabs-container { position: sticky; top: 0; z-index: 10; margin: 16px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background: var(--bg-blur); border-top: 1px solid var(--border-primary); border-bottom: 1px solid var(--border-primary); }
    .tabs { display: flex; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
    .tabs::-webkit-scrollbar { display: none; }
    .tabs__button {
      flex-shrink: 0; cursor: pointer; color: #c7d2fe; background: transparent; border: none; border-bottom: 2px solid transparent;
      padding: 12px 16px; font-size: 15px; text-decoration: none; transition: background-color .2s, border-color .2s, color .2s;
    }
    .tabs__button:hover { background: rgba(167,139,250,.1); }
    .tabs__button[aria-selected="true"] { color: var(--text-primary); font-weight: 600; border-bottom-color: var(--color-accent); }
    .tabs__button:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; border-radius: 8px; }

    .tabs-tools { display:flex; gap:8px; justify-content:flex-end; padding: 8px 16px; }
    .button { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid var(--border-primary); background: rgba(15,23,42,.6); color: var(--text-primary); cursor:pointer; }
    .button:hover { background: rgba(167,139,250,.12); }
    .button[aria-pressed="true"] { outline:2px solid var(--color-accent); outline-offset:2px; }

    .tab-panels { padding-top: 16px; }
    [hidden] { display: none !important; }
    .tab-panel { animation: fadeIn .4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 20px; }
    .card:not(:last-child) { margin-bottom: 16px; }
    .card__title { margin: 0 0 16px; font-size: 20px; color: #dbeafe; }
    .card__subtitle { margin: 4px 0 8px; font-size: 16px; color: #e9d5ff; }

    .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media(min-width: 900px){ .kpi-grid { grid-template-columns: repeat(4, 1fr); } }
    .kpi-card { display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-primary); border-radius: 14px; padding: 14px; background: linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.2)); }
    .kpi-card__value { font-size: 20px; font-weight: 700; }
    .kpi-card__label { color: var(--text-muted); font-size: 12px; }
    .kpi-card__ring { --p:55; width: 44px; height: 44px; flex-shrink: 0; margin-left: auto; border-radius: 50%; background: conic-gradient(var(--color-primary) calc(var(--p) * 1%), rgba(56, 189, 248, .15) 0); border: 2px solid rgba(255,255,255,.06); }

    .chip { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border-primary); margin: 4px 6px 0 0; font-size: 12px; background: rgba(11,18,32,.6); }

    .legend { display: flex; flex-wrap: wrap; gap: 4px 12px; margin-top: 10px; }
    .legend__item { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; }
    .legend__swatch { display: inline-block; width: 10px; height: 10px; border-radius: 3px; }
    .legend__swatch--success { background: var(--color-success); }
    .legend__swatch--primary { background: var(--color-primary); }
    .legend__swatch--accent { background: var(--color-accent); }
    .legend__swatch--warning { background: var(--color-warning); }

    .timeline { position: relative; padding-left: 12px; border-left: 2px solid; border-image: linear-gradient(to bottom, var(--color-primary), transparent) 1; }
    .timeline__item { position: relative; margin: 12px 0; padding-left: 24px; }
    .timeline__item::before { content:""; position: absolute; left: -7px; top: 6px; width: 12px; height: 12px; border-radius: 50%; background: var(--color-primary); box-shadow: 0 0 0 4px rgba(56,189,248,.2); }

    details { border: 1px solid var(--border-primary); border-radius: 12px; padding: 12px 16px; background: rgba(15,23,42,.5); }
    details + details { margin-top: 10px; }
    summary { cursor: pointer; list-style: none; }
    summary::-webkit-details-marker { display: none; }
    summary::after { content: ' ▼'; font-size: 0.8em; color: var(--text-muted); float: right; }
    details[open] summary::after { content: ' ▲'; }
    summary:focus-visible { outline:2px solid var(--color-primary); outline-offset:4px; border-radius:6px; }

    .text-muted { color: var(--text-muted); }
    .text-small { font-size: 13px; }
    .kbd { display:inline-block; padding:2px 6px; border-radius:4px; border:1px solid var(--border-primary); background: rgba(255,255,255,.06); font-size:12px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background: rgba(167,139,250,.18); border:1px solid var(--border-primary); font-size:12px; }

    /* 하단 Quick Bar */
    .helper-bar { position: fixed; left:0; right:0; bottom:0; z-index: 20; background: rgba(11,18,32,.9); backdrop-filter: blur(8px); border-top:1px solid var(--border-primary); }
    .helper-bar__inner { max-width:1080px; margin:0 auto; padding:8px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .helper-bar__item { display:flex; gap:6px; align-items:center; font-size: 13px; }
    .helper-bar__controls { margin-left:auto; display:flex; gap:8px; }
    .helper-bar[aria-hidden="true"] { display:none; }

    /* 폼/컨트롤 */
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .row { display:flex; align-items:center; gap:6px; }
    .field input[type="number"], .field select { width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border-primary); background: rgba(15,23,42,.6); color: var(--text-primary); }
    .field input[type="checkbox"] { width:auto; }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }
    @media (forced-colors: active) {
      .tabs__button[aria-selected="true"] { border-bottom-color: CanvasText; }
      .skip-link:focus { outline-color: CanvasText; }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">본문으로 건너뛰기</a>
  <div class="container">
    <header class="hero">
      <h1 class="hero__title">Sub-3 통합 프로그램 v4.0</h1>
      <p class="hero__subtitle">개인화 · 과학적 근거 · 리스크 관리 · 레이스 실행까지 한 화면에</p>
      <div class="hero__tags">
        <span class="hero__tag"><i>🎯</i> 목표 MP 4:14–4:16/km</span>
        <span class="hero__tag"><i>📆</i> 52주(2피크 가능)</span>
        <span class="hero__tag"><i>🧪</i> 근거 기반</span>
        <span class="hero__tag"><i>🧭</i> 의사결정 트리</span>
      </div>
    </header>

    <div class="tabs-container">
      <div class="tabs" role="tablist" aria-label="훈련 프로그램 섹션" aria-orientation="horizontal">
        <button class="tabs__button" role="tab" aria-selected="true" aria-controls="panel-overview" id="tab-overview">개요</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-intensity" id="tab-intensity" tabindex="-1">강도</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-personalize" id="tab-personalize" tabindex="-1">개인화</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-weather" id="tab-weather" tabindex="-1">날씨</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-tests" id="tab-tests" tabindex="-1">테스트</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-glossary" id="tab-glossary" tabindex="-1">용어집</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-macro" id="tab-macro" tabindex="-1">52주</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-weekly" id="tab-weekly" tabindex="-1">주간</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-guard" id="tab-guard" tabindex="-1">튜닝</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-special" id="tab-special" tabindex="-1">특수</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-taper" id="tab-taper" tabindex="-1">테이퍼</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-race" id="tab-race" tabindex="-1">레이스</button>
        <button class="tabs__button" role="tab" aria-selected="false" aria-controls="panel-evidence" id="tab-evidence" tabindex="-1">근거</button>
      </div>
      <div class="tabs-tools">
        <button id="help-toggle" class="button" aria-pressed="false" aria-label="도움말 모드 전환"><span aria-hidden="true">❓</span> 도움말</button>
      </div>
    </div>

    <main id="main" class="tab-panels">
      <section id="panel-overview" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-overview">
        <div class="card">
          <h2 class="card__title">한눈에 보는 핵심 <span class="badge">즉시 갱신</span></h2>
          <div class="kpi-grid">
            <div class="kpi-card"><div><div class="kpi-card__value"><span id="kpi-mp">4:14–4:16</span></div><div class="kpi-card__label">MP (min/km)</div></div></div>
            <div class="kpi-card"><div><div class="kpi-card__value">75–110 km</div><div class="kpi-card__label">주간 피크 볼륨(레벨별)</div></div></div>
            <div class="kpi-card"><div><div class="kpi-card__value"><span id="kpi-cho">60–90(120)</span> g/h</div><div class="kpi-card__label">CHO 섭취(>90분)</div></div></div>
            <div class="kpi-card"><div><div class="kpi-card__value">−41~60%</div><div class="kpi-card__label">테이퍼 볼륨 감량</div></div><div class="kpi-card__ring" title="테이퍼 감량 시각화: 100% 중 55% 수준으로 감량" style="--p:55" aria-hidden="true"></div></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li><strong>MP</strong>: 마라톤에서 1 km마다 목표로 삼는 분/초.</li>
              <li><strong>CHO g/h</strong>: 시간당 탄수화물 섭취량(그램). 장거리·고강도일수록 상단 권장.</li>
              <li><strong>즉시 갱신</strong>: 개인화 입력이나 날씨를 바꾸면 여기 수치가 바로 바뀝니다.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-intensity" class="tab-panel" role="tabpanel" aria-labelledby="tab-intensity" hidden>
        <div class="card">
          <h2 class="card__title">강도 키(페이스 기준)</h2>
          <div class="grid grid--3-cols">
            <div>
              <h3 class="card__subtitle">기본</h3>
              <span class="chip">Easy: MP +60~90s</span>
              <span class="chip">Aerobic: MP +30~60s</span>
              <span class="chip">Strides: 6–10×80–120m</span>
              <span class="chip" id="chip-easy">Easy(개인화): —</span>
              <span class="chip" id="chip-aerobic">Aerobic(개인화): —</span>
            </div>
            <div>
              <h3 class="card__subtitle">품질</h3>
              <span class="chip">T: HM pace ±0–10s 또는 20–40′</span>
              <span class="chip">10K pace: 최근 10K 기준</span>
              <span class="chip">CV: 5K pace +8–12s</span>
              <span class="chip" id="chip-t">T(개인화): —</span>
              <span class="chip" id="chip-10k">10K(개인화): —</span>
              <span class="chip" id="chip-cv">CV(개인화): —</span>
            </div>
            <div>
              <h3 class="card__subtitle">롱런</h3>
              <span class="chip">Prog LR: 후반 6–12 km 점증</span>
              <span class="chip">MP Blocks: 2×(5–8 km @MP)</span>
              <span class="chip">상한: 32–34 km</span>
            </div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li><strong>Easy/Aerobic</strong>: 숨가쁨 없이 대화 가능. MP에 초/킬로미터를 더해 속도를 낮춰 달립니다.</li>
              <li><strong>T(템포)</strong>: 말수가 줄어드는 ‘약간 힘듦’. 하프 페이스 전후에서 20–40분.</li>
              <li><strong>CV</strong>: 5K 페이스보다 약간 느리게, 인터벌(예: 6×1km)로 수행.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-personalize" class="tab-panel" role="tabpanel" aria-labelledby="tab-personalize" hidden>
        <div class="card">
          <h2 class="card__title">내 데이터 입력</h2>
          <form id="calc-form" class="grid grid--2-cols" aria-describedby="calc-help">
            <div>
              <h3 class="card__subtitle">신체/환경</h3>
              <label class="field">성별
                <select id="in-sex" aria-label="성별">
                  <option value="male">남성</option>
                  <option value="female">여성</option>
                </select>
              </label>
              <label class="field">나이
                <input id="in-age" type="number" inputmode="numeric" min="12" max="90" step="1" />
              </label>
              <label class="field">키 (cm)
                <input id="in-height" type="number" inputmode="decimal" min="120" max="220" step="1" />
              </label>
              <label class="field">몸무게 (kg)
                <input id="in-weight" type="number" inputmode="decimal" min="35" max="120" step="0.1" />
              </label>
              <label class="field">날씨
                <select id="in-weather" aria-label="날씨 상태">
                  <option value="normal">보통</option>
                  <option value="heat">더위</option>
                  <option value="cold">추위</option>
                  <option value="rain">비</option>
                  <option value="snow">눈·결빙</option>
                  <option value="hail">우박·악천후</option>
                  <option value="wind">강풍</option>
                </select>
              </label>
              <div id="calc-help" class="text-small text-muted">기록은 하나만 입력해도 계산됩니다(우선: 마라톤 → 하프 → 10K → 5K).</div>
              <div class="row" style="gap:8px">
                <button type="button" id="btn-calc" class="button">계산</button>
                <button type="button" id="btn-reset" class="button" title="입력 초기화">초기화</button>
              </div>
            </div>
            <div>
              <h3 class="card__subtitle">최근 기록</h3>
              <label class="field">5K (분:초)
                <div class="row">
                  <input id="in-5k-m" type="number" min="12" max="40" step="1" aria-label="5K 분" />
                  <span aria-hidden="true">:</span>
                  <input id="in-5k-s" type="number" min="0" max="59" step="1" aria-label="5K 초" />
                </div>
              </label>
              <label class="field">10K (분:초)
                <div class="row">
                  <input id="in-10k-m" type="number" min="25" max="80" step="1" aria-label="10K 분" />
                  <span aria-hidden="true">:</span>
                  <input id="in-10k-s" type="number" min="0" max="59" step="1" aria-label="10K 초" />
                </div>
              </label>
              <label class="field">하프(HH:MM:SS)
                <div class="row">
                  <input id="in-hm-h" type="number" min="0" max="3" step="1" aria-label="하프 시간" />
                  <span aria-hidden="true">:</span>
                  <input id="in-hm-m" type="number" min="0" max="59" step="1" aria-label="하프 분" />
                  <span aria-hidden="true">:</span>
                  <input id="in-hm-s" type="number" min="0" max="59" step="1" aria-label="하프 초" />
                </div>
              </label>
              <label class="field">마라톤(HH:MM:SS)
                <div class="row">
                  <input id="in-m-h" type="number" min="2" max="7" step="1" aria-label="마라톤 시간" />
                  <span aria-hidden="true">:</span>
                  <input id="in-m-m" type="number" min="0" max="59" step="1" aria-label="마라톤 분" />
                  <span aria-hidden="true">:</span>
                  <input id="in-m-s" type="number" min="0" max="59" step="1" aria-label="마라톤 초" />
                </div>
              </label>
            </div>
          </form>
        </div>

        <div class="card">
          <h3 class="card__subtitle">개인화 결과</h3>
          <div class="grid grid--4-cols">
            <div><span class="text-small text-muted">BMI</span><div id="out-bmi" aria-live="polite">—</div></div>
            <div><span class="text-small text-muted">MP</span><div id="out-mp" aria-live="polite">—</div></div>
            <div><span class="text-small text-muted">CHO 권장</span><div id="out-cho" aria-live="polite">—</div></div>
            <div><span class="text-small text-muted">수분 권장</span><div id="out-hydr" aria-live="polite">—</div></div>
            <div><span class="text-small text-muted">Na 권장</span><div id="out-na" aria-live="polite">—</div></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li><strong>계산식(간단)</strong>: 마라톤 예측시간 = 입력기록 × (42.195 / 입력거리)<sup>1.06</sup> → 1km당 페이스로 변환.</li>
              <li><strong>CHO</strong>: 0.8–1.0 g × 체중(kg)/h, 최소 60 g/h, 최대 120 g/h.</li>
              <li><strong>수분</strong>: 보통 6–10, 더위 8–12 mL × 체중(kg)/h → L/h로 표시.</li>
              <li><strong>Na</strong>: 보통 300–600 mg/h, 더위 600–1000 mg/h.</li>
              <li><strong>마스터스(≥40세)</strong>: Easy/Aerobic/T/CV 상단에 +3~5 s/km 보수 적용.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-weather" class="tab-panel" role="tabpanel" aria-labelledby="tab-weather" hidden>
        <div class="card">
          <h2 class="card__title">날씨별 대응 가이드</h2>
          <div class="grid grid--3-cols">
            <div>
              <h3 class="card__subtitle">페이스 보정(+s/km)</h3>
              <div class="text-small">Easy <strong id="wx-easy">+0</strong>, Aerobic <strong id="wx-aer">+0</strong>, T <strong id="wx-t">+0</strong>, CV <strong id="wx-cv">+0</strong></div>
            </div>
            <div>
              <h3 class="card__subtitle">롱런 보정</h3>
              <div class="text-small"><strong id="wx-lr">0%</strong></div>
            </div>
            <div>
              <h3 class="card__subtitle">실내 전환</h3>
              <div class="text-small"><strong id="wx-indoor">아니오</strong></div>
            </div>
          </div>
          <div style="margin-top:12px" class="text-small">
            수분: <strong id="wx-hydr">—</strong> · Na: <strong id="wx-na">—</strong>
          </div>
          <ul id="weather-tips" style="margin-top:12px"></ul>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li>더위: 페이스 늦추기, 수분·Na 상단 적용, 시간 단축(10–20%).</li>
              <li>눈/결빙·우박: 실내 권장/필수, 롱런 10–30% 단축.</li>
              <li>강풍: 루프 코스/실내, 맞바람 구간은 RPE 기준.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-tests" class="tab-panel" role="tabpanel" aria-labelledby="tab-tests" hidden>
        <div class="card">
          <h2 class="card__title">테스트(입력 최신화 일정)</h2>
          <ul>
            <li>W8: 5K 타임 트라이얼</li>
            <li>W12: 10K 레이스/테스트</li>
            <li>W18±2: 하프마라톤 B-레이스</li>
            <li>W28: (옵션) 5K 재측정</li>
            <li>W30: (옵션) 8–10K 템포/레이스</li>
            <li>W32: 마라톤 A 레이스</li>
          </ul>
          <p class="text-small text-muted">테스트 후 <a href="#panel-personalize">개인화</a> 기록을 갱신하면 모든 수치가 즉시 업데이트됩니다.</p>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li>짧은 거리(5K/10K)는 스피드 지표, 하프/풀은 마라톤 예측에 더 유효.</li>
              <li>3–4주마다 1회 재측정하면 강도 설정 정확도가 올라갑니다.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-glossary" class="tab-panel" role="tabpanel" aria-labelledby="tab-glossary" hidden>
        <div class="card">
          <h2 class="card__title">용어집(쉽게 보기)</h2>
          <dl class="text-small">
            <dt><strong>MP</strong></dt><dd>마라톤 목표 페이스(분:초/킬로).</dd>
            <dt><strong>Easy</strong></dt><dd>편안한 달리기. 대화 가능. MP +60~90초.</dd>
            <dt><strong>Aerobic</strong></dt><dd>조금 더 빠른 기본 달리기. MP +30~60초.</dd>
            <dt><strong>T(템포)</strong></dt><dd>젖산역치 근처. 20–40분 지속 가능한 ‘약간 힘듦’.</dd>
            <dt><strong>CV</strong></dt><dd>임계속도. 5K 페이스보다 약간 느리게 인터벌.</dd>
            <dt><strong>Strides</strong></dt><dd>80–120m 짧고 빠르게 6–10회, 자세/리듬 개선.</dd>
            <dt><strong>CHO g/h</strong></dt><dd>시간당 탄수화물 섭취량(그램). 장거리·고강도일수록 증가.</dd>
            <dt><strong>수분 L/h</strong></dt><dd>시간당 섭취하는 물의 양(리터). 날씨·체중에 따라 조절.</dd>
            <dt><strong>Na mg/h</strong></dt><dd>시간당 나트륨 섭취량(밀리그램). 땀 염도/더위에 따라 증가.</dd>
            <dt><strong>Riegel 1.06</strong></dt><dd>다른 거리 기록으로 마라톤 시간을 예측하는 지수.</dd>
            <dt><strong>마스터스</strong></dt><dd>40세 이상. 회복·보수적 강도 설정 권장.</dd>
            <dt><strong>LR</strong></dt><dd>롱런(Long Run). 주간 최장 거리.</dd>
            <dt><strong>컷백</strong></dt><dd>3–4주마다 1주 볼륨 20–35% 줄여 회복.</dd>
          </dl>
        </div>
      </section>

      <section id="panel-macro" class="tab-panel" role="tabpanel" aria-labelledby="tab-macro" hidden>
        <div class="card">
          <h2 class="card__title">52주 로드맵</h2>
          <div class="timeline">
            <div class="timeline__item"><strong>프렙 W1–4</strong> · 습관·회복 · Easy/언덕 스프린트</div>
            <div class="timeline__item"><strong>베이스1 W5–12</strong> · 유산소 토대 · T(짧게)/언덕 · LR 24–28 km</div>
            <div class="timeline__item"><strong>베이스2 W13–20</strong> · LT/10K 강화 · HM B-레이스</div>
            <div class="timeline__item"><strong>스페시픽1 W21–28</strong> · MP 블록/Prog LR · 연료 전략 리허설</div>
            <div class="timeline__item"><strong>피크·테이퍼 W29–32</strong> · LR 32–34 km 1–2회 후 점감 · 레이스</div>
            <div class="timeline__item"><strong>리커버리 W33–36</strong> · 구조적 회복 · Easy/크로스</div>
            <div class="timeline__item"><strong>스페시픽2 W37–46</strong> · 가을 A' 또는 B 레이스 준비</div>
            <div class="timeline__item"><strong>테이퍼B W47–50</strong> · 볼륨 −30~50%</div>
            <div class="timeline__item"><strong>오프·리셋 W51–52</strong> · 걷기/요가/가벼운 조깅</div>
          </div>
          <p class="text-small text-muted" style="margin-top:12px">3–4주마다 컷백(−20~35%). HM 약 W18±2, 마라톤 A W32, 선택 B W50.</p>
        </div>
      </section>

      <section id="panel-weekly" class="tab-panel" role="tabpanel" aria-labelledby="tab-weekly" hidden>
        <div class="card">
          <h2 class="card__title">주간 템플릿</h2>
          <div class="grid grid--2-cols">
            <div><h3 class="card__subtitle">베이스 주</h3><ul><li>월: Easy 10–14 + Strides</li><li>화: 언덕 10×60" 또는 CV 5×5'(2')</li><li>수: Aerobic 12–16</li><li>목: T 2×5 km(2–3') 또는 T 30–40'</li><li>금: Easy 8–12 + S&C 25’</li><li>토: Easy 10–14(잔디/트레일)</li><li>일: LR 24–28(후반 4–6 km 점증)</li></ul></div>
            <div><h3 class="card__subtitle">스페시픽 주</h3><ul><li>월: 회복 8–12 + 모빌리티</li><li>화: 10×1 km @10K(60–75")</li><li>수: Aerobic 14–18 + Strides</li><li>목: MP 블록 2×(6–8 km) / 2–3 km 조깅</li><li>금: Easy 8–12 + S&C 20’</li><li>토: Easy 10–12</li><li>일: LR 28–32(후반 8–12 km @MP~MP+10s)</li></ul></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <ul class="text-small text-muted" style="margin-top:8px">
              <li>품질 간 회복 48–72h 확보(마스터스는 긴 회복 권장).</li>
              <li>날씨 보정이 자동 반영되므로, 계획 대비 RPE가 과도하면 반복 수를 줄이세요.</li>
            </ul>
          </details>
        </div>
      </section>

      <section id="panel-guard" class="tab-panel" role="tabpanel" aria-labelledby="tab-guard" hidden>
        <div class="card">
          <h2 class="card__title">교체 매트릭스(오버리치 방지)</h2>
          <div class="grid grid--2-cols">
            <div><h3 class="card__subtitle">트리거</h3><ul><li>RHR 베이스+≥5 bpm</li><li>HRV Status Low/Unbalanced 또는 7일평균 ≤ 28일 중앙값−10%</li><li>RPE ≥ 7</li></ul></div>
            <div><h3 class="card__subtitle">조치</h3><ul><li>하루 2개 이상 신호가 2일 연속 → 가장 높은 난이도 품질 1개 삭제</li><li>롱런 유지, 길이 −10~20%, 강도 완화</li><li>더위/고도 첫 7–10일: 모든 강도 −1단계</li></ul></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <p class="text-small text-muted">피로 신호가 겹치면 과감히 줄이는 것이 장기 성과에 유리합니다.</p>
          </details>
        </div>
      </section>

      <section id="panel-special" class="tab-panel" role="tabpanel" aria-labelledby="tab-special" hidden>
        <div class="card">
          <h2 class="card__title">특수 군: 여성·마스터스·부상 복귀</h2>
          <div class="grid grid--3-cols">
            <div><h3 class="card__subtitle">여성</h3><ul><li>황체기: T/VO2 10–15 s/km 완화 또는 볼륨 −10~15%</li><li>수분·Na 상향</li></ul></div>
            <div><h3 class="card__subtitle">마스터스(40세↑)</h3><ul><li>품질 간 회복 48–72 h</li><li>점진적 플라이오메트릭스</li><li>2:1 적재:컷백 허용</li></ul></div>
            <div><h3 class="card__subtitle">부상 복귀</h3><ol class="text-small"><li>1'/1'×10–15 → 3'/2'×6–8 → 10–30' 연속 Easy</li><li>통증 2/10↑ 또는 다음날 잔존 시 단계 −1</li><li>품질·언덕 금지</li></ol></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <p class="text-small text-muted">개별 회복력 차이를 고려하여 강도 상단을 보수적으로 설정합니다.</p>
          </details>
        </div>
      </section>

      <section id="panel-taper" class="tab-panel" role="tabpanel" aria-labelledby="tab-taper" hidden>
        <div class="card">
          <h2 class="card__title">테이퍼(2–3주)</h2>
          <ul><li>주간 볼륨 −41~60% 점감, 강도·빈도 유지</li><li>마지막 7–10일: MP 촉감 6–10 km 1회, 400 m×6 가볍게</li></ul>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <p class="text-small text-muted">볼륨만 줄이고 강도는 유지해야 레이스 날 컨디션이 좋습니다.</p>
          </details>
        </div>
      </section>

      <section id="panel-race" class="tab-panel" role="tabpanel" aria-labelledby="tab-race" hidden>
        <div class="card">
          <h2 class="card__title">레이스 실행(서브3)</h2>
          <div class="grid grid--3-cols">
            <div><h3 class="card__subtitle">페이싱</h3><ul><li>0–5 km: MP+5–8s</li><li>5–35 km: MP 안정</li><li>35–42.2 km: 상황별 −5~+10s</li></ul></div>
            <div><h3 class="card__subtitle">급수/영양</h3><ul><li>젤: 30–35분마다 1개(20–30 g)</li><li>CHO 60–90(적응 시 90–110) g/h</li><li>수분 0.4–0.8 L/h · Na 300–600 mg/h(더위 800–1000)</li></ul></div>
            <div><h3 class="card__subtitle">체크리스트</h3><ul><li>레이스화 2–3회 사전 검증</li><li>젤/음료 브랜드 리허설 완료</li><li>날씨 플랜 A/B/C 준비</li></ul></div>
          </div>
          <details class="help" style="margin-top:12px">
            <summary>도움말</summary>
            <p class="text-small text-muted">초반 과속을 피하고, 연료/수분은 계획대로 꾸준히.</p>
          </details>
        </div>
      </section>

      <section id="panel-evidence" class="tab-panel" role="tabpanel" aria-labelledby="tab-evidence" hidden>
        <div class="card">
          <h2 class="card__title">근거(학술 문헌, 중복 제거)</h2>
          <ol class="cols-2 text-small">
            <li>Thomas DT, Erdman KA, Burke LM. Nutrition and Athletic Performance. J Acad Nutr Diet. 2016;116(3):501–528; Med Sci Sports Exerc. 48(3):543–568.</li>
            <li>ACSM Position Stand. Exercise and Fluid Replacement. Med Sci Sports Exerc. 2007;39(2):377–390.</li>
            <li>Jeukendrup AE. Multiple transportable carbohydrates and endurance performance. Sports Med. 2010–2014.</li>
            <li>Bosquet L, et al. Effects of tapering on performance: meta-analysis. Med Sci Sports Exerc. 2007;39(8):1358–1365.</li>
            <li>Seiler S. Training intensity distribution and endurance performance. 2009–2010.</li>
            <li>Stöggl T, Sperlich B. Polarized vs. threshold training. Front Physiol. 2014;5:33.</li>
            <li>Périard JD, et al. Heat acclimation and endurance performance. Sports Med. 2015–2021.</li>
            <li>Quantitative Analysis of 92 12-Week Sub-elite Marathon Training Plans. PMC.</li>
            <li>The Training Characteristics of World-Class Distance Runners.</li>
            <li>Factors Influencing Running Performance During a Marathon: Breaking the 2-h Barrier. PMC.</li>
            <li>Genes and Elite Marathon Running Performance: Systematic Review. PMC.</li>
            <li>Post-analysis methods for lactate threshold in runners. PMC.</li>
            <li>Physiological and training characteristics of recreational marathon runners. PMC.</li>
            <li>Strength training and running economy: systematic reviews/meta-analyses. PMC.</li>
            <li>Advanced footwear technology and elite marathon speed.</li>
            <li>Training periodization/intensity distribution in elite distance runners. IJSPP 2022;17(6):820.</li>
            <li>Training intensity distribution among endurance athletes. PMC.</li>
            <li>Editorial: training intensity, volume, recovery distribution. PMC.</li>
            <li>Training intensity distribution of marathon runners across performance levels. PubMed.</li>
            <li>Training for a (half-)marathon: volume/longest run vs performance/injury. PMC.</li>
            <li>Determinants of marathon performance: meta-analysis with meta-regression. PubMed.</li>
            <li>Lactate-guided intervals within high-volume low-intensity approach. PMC.</li>
            <li>HIIT effects in recreational endurance runners: systematic review. PMC.</li>
            <li>Running-specific strength/endurance/concurrent training effects. PMC.</li>
            <li>Nutrition concepts for elite distance runners. PMC.</li>
            <li>Marathon nutrition: fuel for training and racing. PubMed.</li>
            <li>Post-exercise recovery nutrition: frameworks/reviews. PMC.</li>
            <li>Carbohydrate periodization & glycogen threshold. PMC.</li>
            <li>Sleep-low train-low intervention in women. EJ-Sport.</li>
            <li>Nutrition/training periodization case study. PubMed.</li>
            <li>Glycogen loading case report (racewalker). PMC.</li>
            <li>Ultra runners’ dietary observations (24h). PMC.</li>
            <li>Marathon runners’ intake/timing vs finish time. PMC.</li>
            <li>120 g/h carbohydrates and muscle damage in mountain marathon. PMC.</li>
            <li>Nutrition and muscle recovery; performance enhancement. PMC.</li>
            <li>Recovery strategies after training/competition: umbrella review. PMC.</li>
            <li>Mental toughness profiles; resilience; mental training effects. PMC/Frontiers.</li>
            <li>Technological advances in elite marathon performance. J Appl Physiol.</li>
            <li>World-class 800/1500-m training science/practice. PMC.</li>
            <li>Recommender systems & ML for marathon runners. PMC.</li>
          </ol>
          <p class="text-small text-muted" style="margin-top:12px;">본 UI는 가이드이며, 개인 의료·생활 제약에 따른 조정이 필요합니다.</p>
        </div>
      </section>
    </main>
  </div>

  <!-- 하단 Quick Bar -->
  <div class="helper-bar" id="quickbar" role="status" aria-live="polite">
    <div class="helper-bar__inner">
      <div class="helper-bar__item"><strong>MP</strong> <span id="q-mp">—</span></div>
      <div class="helper-bar__item"><strong>Easy</strong> <span id="q-easy">—</span></div>
      <div class="helper-bar__item"><strong>T</strong> <span id="q-t">—</span></div>
      <div class="helper-bar__item"><strong>CV</strong> <span id="q-cv">—</span></div>
      <div class="helper-bar__item"><strong>CHO</strong> <span id="q-cho">—</span></div>
      <div class="helper-bar__item"><strong>수분</strong> <span id="q-hydr">—</span></div>
      <div class="helper-bar__item"><strong>Na</strong> <span id="q-na">—</span></div>
      <div class="helper-bar__item"><span class="badge" id="q-weather">보통</span> <span class="badge" id="q-masters" aria-hidden="true" style="display:none">마스터스</span></div>
      <div class="helper-bar__controls">
        <button class="button" id="btn-copy" title="요약 복사"><span aria-hidden="true">📋</span> 복사</button>
        <button class="button" id="btn-hidebar" title="하단 바 숨기기/보이기"><span aria-hidden="true">🞂</span> 접기</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tablist = document.querySelector('[role="tablist"]');
      if (!tablist) return;

      const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
      const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

      const getSelectedTab = () => tabs.find(t => t.getAttribute('aria-selected') === 'true') || tabs[0];
      const activate = (tab) => {
        if (!tab) return;
        for (const t of tabs) {
          t.setAttribute('aria-selected', String(t === tab));
          t.setAttribute('tabindex', t === tab ? '0' : '-1');
        }
        const targetId = tab.getAttribute('aria-controls');
        for (const p of panels) {
          const isTarget = p.id === targetId;
          if (isTarget) p.removeAttribute('hidden'); else p.setAttribute('hidden', '');
        }
        if (targetId && !location.hash.startsWith(`#${targetId}`)) {
          history.replaceState(null, '', `#${targetId}`);
        }
        tab.focus();
        tab.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
      };

      const initTabs = () => {
        const hashId = location.hash?.slice(1);
        const byHash = hashId ? tabs.find(t => t.getAttribute('aria-controls') === hashId) : null;
        activate(byHash || getSelectedTab());
      };

      tablist.addEventListener('click', (e) => {
        const clickedTab = e.target.closest('button[role="tab"]');
        if (clickedTab) activate(clickedTab);
      });
      tablist.addEventListener('keydown', (e) => {
        const current = e.target.closest('button[role="tab"]');
        if (!current) return;
        const i = tabs.indexOf(current);
        let next = null;
        if (e.key === 'ArrowRight') next = tabs[(i + 1) % tabs.length];
        else if (e.key === 'ArrowLeft') next = tabs[(i - 1 + tabs.length) % tabs.length];
        else if (e.key === 'Home') next = tabs[0];
        else if (e.key === 'End') next = tabs[tabs.length - 1];
        else return;
        e.preventDefault();
        activate(next);
      });
      window.addEventListener('hashchange', () => {
        const id = location.hash?.slice(1);
        const match = id ? tabs.find(t => t.getAttribute('aria-controls') === id) : null;
        if (match) activate(match);
      });

      initTabs();

      // 날씨 규칙
      const WEATHER_RULES = {
        normal: { mlPerKg:[6,10], na:[300,600], paceAdj:{easy:0,aer:0,t:0,cv:0}, lrPct:[0,0], indoor:'아니오', tips:['일반 조건. 계획대로 진행.'] },
        heat:   { mlPerKg:[8,12], na:[600,1000], paceAdj:{easy:10,aer:8,t:12,cv:8}, lrPct:[-20,-10], indoor:'조건부', tips:['서늘한 시간대로 이동','그늘/급수 확보','반복수 10–20% 축소','열증상 시 중단'] },
        cold:   { mlPerKg:[4,8],  na:[300,500], paceAdj:{easy:4,aer:4,t:6,cv:4},   lrPct:[-10,0],  indoor:'조건부', tips:['워밍업 연장','겹겹이 착용','빙판 시 고강도 보류'] },
        rain:   { mlPerKg:[6,10], na:[300,600], paceAdj:{easy:5,aer:5,t:8,cv:5},   lrPct:[-10,0],  indoor:'조건부', tips:['미끄럼 주의','인터벌은 트레드밀 고려','저체온 예방'] },
        snow:   { mlPerKg:[6,10], na:[300,600], paceAdj:{easy:12,aer:12,t:20,cv:15},lrPct:[-30,-10], indoor:'권장', tips:['실내 대체 권장','롱런 10–30% 단축','다운힐/VO2 금지'] },
        hail:   { mlPerKg:[6,10], na:[300,600], paceAdj:{easy:15,aer:15,t:25,cv:20},lrPct:[-30,-10], indoor:'필수', tips:['실내로 전환','야외 훈련 연기'] },
        wind:   { mlPerKg:[6,10], na:[300,600], paceAdj:{easy:4,aer:4,t:6,cv:6},   lrPct:[-10,0],  indoor:'조건부', tips:['루프 코스 사용','맞바람 구간 RPE 기준','실내 대체'] }
      };

      // 요소 참조
      const $ = (id) => document.getElementById(id);
      const els = {
        sex: $('in-sex'), age: $('in-age'),
        height: $('in-height'), weight: $('in-weight'), weather: $('in-weather'),
        k5m: $('in-5k-m'), k5s: $('in-5k-s'),
        k10m: $('in-10k-m'), k10s: $('in-10k-s'),
        hmH: $('in-hm-h'), hmM: $('in-hm-m'), hmS: $('in-hm-s'),
        mH: $('in-m-h'), mM: $('in-m-m'), mS: $('in-m-s'),
        outBMI: $('out-bmi'), outMP: $('out-mp'),
        outCHO: $('out-cho'), outHydr: $('out-hydr'), outNa: $('out-na'),
        kpiMP: $('kpi-mp'), kpiCHO: $('kpi-cho'),
        chipEasy: $('chip-easy'), chipAer: $('chip-aerobic'),
        chipT: $('chip-t'), chip10K: $('chip-10k'), chipCV: $('chip-cv'),
        wx: { easy:$('wx-easy'), aer:$('wx-aer'), t:$('wx-t'), cv:$('wx-cv'), lr:$('wx-lr'), indoor:$('wx-indoor'), tips:$('weather-tips'), hydr:$('wx-hydr'), na:$('wx-na') },
        quick: { mp:$('q-mp'), easy:$('q-easy'), t:$('q-t'), cv:$('q-cv'), cho:$('q-cho'), hydr:$('q-hydr'), na:$('q-na'), weather:$('q-weather'), masters:$('q-masters') },
        kbar: $('quickbar'), btnCopy: $('btn-copy'), btnHideBar: $('btn-hidebar'),
        btnCalc: $('btn-calc'), btnReset: $('btn-reset'), helpToggle: $('help-toggle')
      };

      const clamp = (v, lo, hi) => Math.min(Math.max(v, lo), hi);
      const secToPace = (sec) => {
        if (!isFinite(sec) || sec <= 0) return '—';
        const s = Math.round(sec);
        const m = Math.floor(s / 60);
        const ss = String(s % 60).padStart(2, '0');
        return `${m}:${ss}`;
      };
      const rangeStr = (a, b) => `${secToPace(a)}–${secToPace(b)}`;
      const riegel = (t1, d1, d2, exp = 1.06) => t1 * Math.pow(d2 / d1, exp);
      const readNumber = (el) => {
        const v = parseFloat(el?.value);
        return Number.isFinite(v) ? v : 0;
      };

      // 상태 저장/복원
      const STATE_KEY = 'sub3_v4_state';
      const saveState = () => {
        const data = {
          sex: els.sex?.value, age: els.age?.value, height: els.height?.value, weight: els.weight?.value, weather: els.weather?.value,
          k5m: els.k5m?.value, k5s: els.k5s?.value, k10m: els.k10m?.value, k10s: els.k10s?.value,
          hmH: els.hmH?.value, hmM: els.hmM?.value, hmS: els.hmS?.value, mH: els.mH?.value, mM: els.mM?.value, mS: els.mS?.value
        };
        try { localStorage.setItem(STATE_KEY, JSON.stringify(data)); } catch(e) {}
      };
      const loadState = () => {
        try {
          const raw = localStorage.getItem(STATE_KEY);
          if (!raw) return;
          const d = JSON.parse(raw);
          Object.entries(d).forEach(([k,v]) => { const el = els[k] || els[k?.split('.')[1]]; if (el && v != null) el.value = v; });
        } catch(e) {}
      };
      const resetState = () => {
        try { localStorage.removeItem(STATE_KEY); } catch(e) {}
        document.getElementById('calc-form')?.reset();
      };

      // 계산
      const calc = () => {
        const age = readNumber(els.age);
        const masters = age >= 40;
        const kg = readNumber(els.weight);
        const hCm = readNumber(els.height);
        const weatherKey = els.weather?.value || 'normal';
        const WR = WEATHER_RULES[weatherKey] || WEATHER_RULES.normal;

        const t5k = (() => { const m = readNumber(els.k5m), s = readNumber(els.k5s); return (m>0||s>0)?(m*60+s):0; })();
        const t10k = (() => { const m = readNumber(els.k10m), s = readNumber(els.k10s); return (m>0||s>0)?(m*60+s):0; })();
        const tHM = (() => { const h = readNumber(els.hmH), m = readNumber(els.hmM), s = readNumber(els.hmS); return (h>0||m>0||s>0)?(h*3600+m*60+s):0; })();
        const tM  = (() => { const h = readNumber(els.mH),  m = readNumber(els.mM),  s = readNumber(els.mS);  return (h>0||m>0||s>0)?(h*3600+m*60+s):0; })();

        if (hCm > 0 && kg > 0) els.outBMI.textContent = (kg / Math.pow(hCm/100,2)).toFixed(1);
        else els.outBMI.textContent = '—';

        const D5=5, D10=10, DHM=21.0975, DM=42.195;

        let mpSecPerKm = 0;
        if (tM>0) mpSecPerKm = tM/DM;
        else if (tHM>0) mpSecPerKm = riegel(tHM, DHM, DM)/DM;
        else if (t10k>0) mpSecPerKm = riegel(t10k, D10, DM)/DM;
        else if (t5k>0) mpSecPerKm = riegel(t5k, D5, DM)/DM;

        const mpStr = mpSecPerKm>0 ? secToPace(mpSecPerKm) : '—';
        els.outMP.textContent = mpStr;
        els.kpiMP.textContent = mpStr !== '—' ? mpStr : '4:14–4:16';

        if (kg>0) {
          const choLo = clamp(kg*0.8,60,120), choHi = clamp(kg*1.0,60,120);
          els.outCHO.textContent = `${Math.round(choLo)}–${Math.round(choHi)} g/h${weatherKey==='heat'?' (상단 권장)':''}`;
          els.kpiCHO.textContent = `${Math.round(choLo)}–${Math.round(choHi)}`;
        } else {
          els.outCHO.textContent = '60–90 g/h';
          els.kpiCHO.textContent = '60–90(120)';
        }

        if (kg>0) {
          const [mlLo, mlHi] = WR.mlPerKg;
          const loL = clamp(kg*mlLo/1000,0.3,1.0), hiL = clamp(kg*mlHi/1000,0.3,1.0);
          const hydrStr = `${loL.toFixed(1)}–${hiL.toFixed(1)} L/h`;
          els.outHydr.textContent = hydrStr; if (els.wx.hydr) els.wx.hydr.textContent = hydrStr;
        } else {
          const hydrStr = weatherKey==='heat' ? '0.6–1.0 L/h' : '0.4–0.8 L/h';
          els.outHydr.textContent = hydrStr; if (els.wx.hydr) els.wx.hydr.textContent = hydrStr;
        }
        const [naLo, naHi] = WR.na;
        const naStr = `${naLo}–${naHi} mg/h`;
        els.outNa.textContent = naStr; if (els.wx.na) els.wx.na.textContent = naStr;

        let pace10=0, pace5=0, paceHM=0;
        if (t10k>0) pace10 = t10k/D10;
        else if (tHM>0) pace10 = riegel(tHM,DHM,D10)/D10;
        else if (t5k>0) pace10 = riegel(t5k,D5,D10)/D10;

        if (t5k>0) pace5 = t5k/D5;
        else if (t10k>0) pace5 = riegel(t10k,D10,D5)/D5;
        else if (tHM>0) pace5 = riegel(tHM,DHM,D5)/D5;

        if (tHM>0) paceHM = tHM/DHM;
        else if (t10k>0) paceHM = riegel(t10k,D10,DHM)/DHM;
        else if (t5k>0) paceHM = riegel(t5k,D5,DHM)/DHM;

        const adjM = { easy: (age>=40?5:0), aer: (age>=40?5:0), t:(age>=40?5:0), cv:(age>=40?3:0) };
        const adjW = WR.paceAdj;

        let easyStr='—', aerStr='—', tStr='—', cvStr='—';
        if (mpSecPerKm>0) {
          easyStr = `${rangeStr(mpSecPerKm+60+adjM.easy+adjW.easy, mpSecPerKm+90+adjM.easy+adjW.easy)} /km`;
          aerStr  = `${rangeStr(mpSecPerKm+30+adjM.aer+adjW.aer,  mpSecPerKm+60+adjM.aer+adjW.aer)} /km`;
          els.chipEasy.textContent = `Easy(개인화): ${easyStr}`;
          els.chipAer.textContent  = `Aerobic(개인화): ${aerStr}`;
        } else {
          els.chipEasy.textContent = 'Easy(개인화): —';
          els.chipAer.textContent  = 'Aerobic(개인화): —';
        }

        els.chip10K.textContent = pace10>0 ? `10K(개인화): ${secToPace(pace10)} /km` : '10K(개인화): —';
        if (paceHM>0) {
          tStr = `${rangeStr(paceHM+0+adjW.t, paceHM+10+adjM.t+adjW.t)} /km`;
          els.chipT.textContent = `T(개인화): ${tStr}`;
        } else if (pace10>0) {
          tStr = `${rangeStr(pace10+10+adjW.t, pace10+15+adjM.t+adjW.t)} /km`;
          els.chipT.textContent = `T(개인화): ${tStr}`;
        } else {
          els.chipT.textContent = 'T(개인화): —';
        }

        if (pace5>0) {
          cvStr = `${rangeStr(pace5+8+adjW.cv, pace5+12+adjM.cv+adjW.cv)} /km`;
          els.chipCV.textContent = `CV(개인화): ${cvStr}`;
        } else if (pace10>0) {
          cvStr = `${rangeStr(pace10+0+adjW.cv, pace10+5+adjM.cv+adjW.cv)} /km`;
          els.chipCV.textContent = `CV(개인화): ${cvStr}`;
        } else {
          els.chipCV.textContent = 'CV(개인화): —';
        }

        // 날씨 요약
        if (els.wx.easy) {
          els.wx.easy.textContent = `+${adjW.easy}`;
          els.wx.aer.textContent  = `+${adjW.aer}`;
          els.wx.t.textContent    = `+${adjW.t}`;
          els.wx.cv.textContent   = `+${adjW.cv}`;
          const [lrLo, lrHi] = WR.lrPct;
          els.wx.lr.textContent = lrLo===lrHi ? `${lrLo}%` : `${lrLo}%~${lrHi}%`;
          els.wx.indoor.textContent = WR.indoor;
          els.wx.tips.innerHTML = (WR.tips||[]).map(t=>`<li>${t}</li>`).join('');
        }

        // Quick Bar
        els.quick.mp.textContent = mpStr;
        els.quick.easy.textContent = easyStr;
        els.quick.t.textContent = tStr;
        els.quick.cv.textContent = cvStr;
        els.quick.cho.textContent = els.outCHO.textContent;
        els.quick.hydr.textContent = els.outHydr.textContent;
        els.quick.na.textContent = els.outNa.textContent;
        els.quick.weather.textContent = ({
          normal:'보통',heat:'더위',cold:'추위',rain:'비',snow:'눈·결빙',hail:'우박·악천후',wind:'강풍'
        })[weatherKey] || '보통';
        els.quick.masters.style.display = age>=40 ? '' : 'none';

        saveState();
      };

      // 도움말 모드: 모든 details 열기/닫기
      const toggleHelp = () => {
        const btn = els.helpToggle;
        const on = btn.getAttribute('aria-pressed') === 'true' ? false : true;
        btn.setAttribute('aria-pressed', String(on));
        document.querySelectorAll('details.help').forEach(d => d.open = on);
      };
      els.helpToggle?.addEventListener('click', toggleHelp);

      // Quick Bar 복사/숨김
      els.btnCopy?.addEventListener('click', async () => {
        const txt = [
          `MP: ${document.getElementById('q-mp').textContent}`,
          `Easy: ${document.getElementById('q-easy').textContent}`,
          `T: ${document.getElementById('q-t').textContent}`,
          `CV: ${document.getElementById('q-cv').textContent}`,
          `CHO: ${document.getElementById('q-cho').textContent}`,
          `수분: ${document.getElementById('q-hydr').textContent}`,
          `Na: ${document.getElementById('q-na').textContent}`,
          `날씨: ${document.getElementById('q-weather').textContent}${document.getElementById('q-masters').style.display===''?' · 마스터스':''}`
        ].join('\n');
        try { await navigator.clipboard.writeText(txt); els.btnCopy.textContent = '복사됨'; setTimeout(()=>{els.btnCopy.textContent='📋 복사';},1200); } catch(e) {}
      });
      els.btnHideBar?.addEventListener('click', () => {
        const hidden = els.kbar.getAttribute('aria-hidden') === 'true' ? false : true;
        els.kbar.setAttribute('aria-hidden', String(hidden));
      });

      // 초기화
      els.btnReset?.addEventListener('click', () => { resetState(); calc(); });

      // 입력 이벤트
      document.getElementById('calc-form')?.addEventListener('input', calc);
      els.btnCalc?.addEventListener('click', calc);

      // 로드 → 복원 → 계산
      loadState();
      calc();
    });
  </script>
</body>
</html>
